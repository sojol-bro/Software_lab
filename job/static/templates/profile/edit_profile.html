{% extends 'base.html' %}
{% load static %}

{% block content %}

<!-- =========================================================
  EDIT PROFILE (Premium / Calm / Professional)
  - Keeps your Django formset logic + templates + JS add/remove
  - Improves: spacing rhythm, visual hierarchy, contrast, focus states,
    mobile usability, sticky actions, better section navigation,
    better form field styling (select/textarea), smoother UX.
  - Django-safe: ONLY increments TOTAL_FORMS; remove uses DELETE checkbox
========================================================= -->

<!-- ================= Floating Status ================= -->
<div id="floating-status"
     class="fixed bottom-5 right-5 z-50 flex items-center gap-3
            rounded-2xl bg-white/85 backdrop-blur border border-slate-200/70
            px-4 py-2 shadow-[0_18px_60px_rgba(15,23,42,0.16)] text-sm font-semibold text-slate-700">
  <span id="save-status">All changes saved</span>
  <span id="save-dot" class="w-2 h-2 rounded-full bg-emerald-500"></span>
</div>

<!-- ================= Page Wrapper ================= -->
<div class="max-w-6xl mx-auto px-4 py-10">
  <div class="rounded-[28px] border border-slate-200/70 bg-white shadow-[0_22px_80px_rgba(15,23,42,0.10)] overflow-hidden">

    <!-- ============== Header / Hero ============== -->
    <div class="relative overflow-hidden border-b border-slate-200/70 bg-gradient-to-br from-[#ECF7FF] via-white to-[#F2FFFB]">
      <!-- soft blobs -->
      <div aria-hidden="true" class="pointer-events-none absolute inset-0">
        <div class="absolute -top-24 -right-24 h-72 w-72 rounded-full bg-sky-400/20 blur-3xl"></div>
        <div class="absolute -bottom-24 -left-24 h-80 w-80 rounded-full bg-emerald-400/15 blur-3xl"></div>
        <div class="absolute inset-0 opacity-[0.08]"
             style="background-image: radial-gradient(#0ea5e9 0.6px, transparent 0.6px); background-size: 18px 18px;"></div>
        <div class="absolute inset-0 bg-gradient-to-b from-white/0 via-white/0 to-white/55"></div>
      </div>

      <div class="relative px-6 md:px-8 py-7 flex flex-col md:flex-row md:items-start md:justify-between gap-6">
        <div>
          <h1 class="text-2xl md:text-3xl font-black tracking-tight text-slate-900">Edit Profile</h1>
          <p class="text-sm text-slate-600 mt-1 max-w-2xl">
            Make your profile CV-ready: clear title, impact experience, projects, and links — clean and easy to scan.
          </p>

          <!-- Mobile quick nav -->
          <div class="mt-4 flex flex-wrap gap-2 lg:hidden">
            <a href="#sec-basic" class="pill">Basic</a>
            <a href="#sec-exp" class="pill">Experience</a>
            <a href="#sec-edu" class="pill">Education</a>
            <a href="#sec-skill" class="pill">Skills</a>
            <a href="#sec-proj" class="pill">Projects</a>
            <a href="#sec-cert" class="pill">Certificates</a>
          </div>
        </div>

        <div class="flex items-center gap-3 md:justify-end">
          <a href="{% url 'app:profile' %}"
             class="inline-flex items-center gap-2 rounded-2xl border border-slate-200/70 bg-white/80 px-4 py-2
                    text-sm font-extrabold text-slate-800 hover:bg-white transition shadow-sm focus-ring">
            <i class="fas fa-user"></i>
            View Profile
          </a>

          <a href="{% url 'app:profile' %}"
             class="inline-flex items-center justify-center w-11 h-11 rounded-2xl border border-slate-200/70 bg-white/80
                    hover:bg-white transition shadow-sm focus-ring"
             title="Close">
            <i class="fas fa-times text-slate-600"></i>
          </a>
        </div>
      </div>
    </div>

    <!-- ============== Main Layout ============== -->
    <div class="grid grid-cols-1 lg:grid-cols-[320px_1fr]">
      <!-- ================= Sidebar ================= -->
      <aside class="hidden lg:block border-r border-slate-200/70 bg-white">
        <div class="sticky top-6 p-6 space-y-4">
          <!-- Completion -->
          <div class="rounded-3xl border border-slate-200/70 bg-white shadow-sm p-5">
            <div class="flex items-start justify-between gap-4">
              <div>
                <p class="text-sm font-black text-slate-900">Profile Completion</p>
                <p class="text-xs text-slate-600 mt-1">Polished profiles get more attention.</p>
              </div>
              <span id="completion-label"
                    class="text-xs font-black text-slate-800 bg-slate-100/80 border border-slate-200/70 px-2 py-1 rounded-full">0%</span>
            </div>

            <div class="mt-4 h-2 rounded-full bg-slate-100 overflow-hidden ring-1 ring-slate-200/60">
              <div id="completion-bar" class="h-full w-0 bg-gradient-to-r from-sky-600 to-emerald-500 transition-all duration-300"></div>
            </div>

            <div class="mt-5 space-y-2">
              <a href="#sec-basic" class="side-link flex items-center justify-between px-3 py-2 rounded-2xl hover:bg-slate-50 transition focus-ring">
                <span class="text-sm font-black text-slate-900">Basic</span>
                <span class="chip" data-chip="basic"></span>
              </a>
              <a href="#sec-exp" class="side-link flex items-center justify-between px-3 py-2 rounded-2xl hover:bg-slate-50 transition focus-ring">
                <span class="text-sm font-black text-slate-900">Experience</span>
                <span class="chip" data-chip="experience"></span>
              </a>
              <a href="#sec-edu" class="side-link flex items-center justify-between px-3 py-2 rounded-2xl hover:bg-slate-50 transition focus-ring">
                <span class="text-sm font-black text-slate-900">Education</span>
                <span class="chip" data-chip="education"></span>
              </a>
              <a href="#sec-skill" class="side-link flex items-center justify-between px-3 py-2 rounded-2xl hover:bg-slate-50 transition focus-ring">
                <span class="text-sm font-black text-slate-900">Skills</span>
                <span class="chip" data-chip="skills"></span>
              </a>
              <a href="#sec-proj" class="side-link flex items-center justify-between px-3 py-2 rounded-2xl hover:bg-slate-50 transition focus-ring">
                <span class="text-sm font-black text-slate-900">Projects</span>
                <span class="chip" data-chip="projects"></span>
              </a>
              <a href="#sec-cert" class="side-link flex items-center justify-between px-3 py-2 rounded-2xl hover:bg-slate-50 transition focus-ring">
                <span class="text-sm font-black text-slate-900">Certificates</span>
                <span class="chip" data-chip="certificates"></span>
              </a>
            </div>
          </div>

          <!-- Tips -->
          <div class="rounded-3xl border border-slate-200/70 bg-gradient-to-b from-sky-50 to-emerald-50 p-5">
            <p class="text-sm font-black text-slate-900">CV Checklist</p>
            <ul class="text-sm text-slate-700 mt-2 space-y-1 list-disc list-inside">
              <li>Short headline (role + niche)</li>
              <li>2–3 impact experiences</li>
              <li>3–6 core skills</li>
              <li>2–4 projects + links</li>
              <li>Certificates (optional)</li>
            </ul>
          </div>

          <!-- Micro help -->
          <div class="rounded-3xl border border-slate-200/70 bg-white p-5">
            <p class="text-sm font-black text-slate-900">Formatting tip</p>
            <p class="text-sm text-slate-600 mt-2">
              Use short bullets and measurable outcomes (%, time saved, users reached).
            </p>
          </div>
        </div>
      </aside>

      <!-- ================= Form Column ================= -->
      <main class="p-6 md:p-8">
        <form id="profile-form" method="POST" enctype="multipart/form-data" class="space-y-8">
          {% csrf_token %}

          <!-- ================= Profile Header Card ================= -->
          <section class="card">
            <div class="card-head">
              <div>
                <h2 class="card-title">Profile</h2>
                <p class="card-sub">Photo + quick identity details.</p>
              </div>
            </div>

            <div class="flex flex-col md:flex-row md:items-center gap-6">
              <!-- picture -->
              <div class="flex items-center gap-4">
                <div class="relative">
                  <img id="profile-preview"
                       src="{% if profile.profile_picture %}{{ profile.profile_picture.url }}{% else %}https://via.placeholder.com/300{% endif %}"
                       alt="Profile Picture"
                       class="w-24 h-24 rounded-2xl object-cover border border-slate-200/70 shadow-sm bg-white" />

                  <label for="profile_picture"
                         class="absolute -bottom-2 -right-2 w-10 h-10 rounded-2xl cursor-pointer
                                bg-slate-900 text-white flex items-center justify-center shadow-md
                                hover:bg-slate-800 transition focus-ring"
                         title="Change photo">
                    <i class="fas fa-camera text-sm"></i>
                  </label>
                  <input type="file" id="profile_picture" name="profile_picture" accept="image/*"
                         class="hidden" onchange="previewImage(this)">
                </div>

                <div>
                  <p class="font-black text-slate-900">Profile Picture</p>
                  <p class="text-sm text-slate-600">Square recommended (min 300×300)</p>
                </div>
              </div>

              <!-- quick actions -->
              <div class="md:ml-auto w-full md:w-auto">
                <div class="rounded-2xl border border-slate-200/70 bg-slate-50/70 p-4">
                  <p class="text-sm font-black text-slate-900">Quick actions</p>
                  <div class="mt-3 flex flex-wrap gap-2">
                    <button type="button" class="mini-btn" onclick="scrollToSection('sec-basic')">
                      <i class="fas fa-id-card"></i> Basic
                    </button>
                    <button type="button" class="mini-btn" onclick="scrollToSection('sec-exp')">
                      <i class="fas fa-briefcase"></i> Experience
                    </button>
                    <button type="button" class="mini-btn" onclick="scrollToSection('sec-proj')">
                      <i class="fas fa-diagram-project"></i> Projects
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- ================= Basic ================= -->
          <section id="sec-basic" class="card">
            <div class="card-head">
              <div>
                <h2 class="card-title">Basic Information</h2>
                <p class="card-sub">Shown in profile header.</p>
              </div>
              <span class="badge">Public</span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="label" for="title">Professional Title</label>
                <input class="input" type="text" id="title" name="title" value="{{ profile.title }}" placeholder="Software Engineer" />
              </div>

              <div>
                <label class="label" for="location">Location</label>
                <input class="input" type="text" id="location" name="location" value="{{ profile.location }}" placeholder="Dhaka, Bangladesh" />
              </div>

              <div>
                <label class="label" for="phone">Phone</label>
                <input class="input" type="tel" id="phone" name="phone" value="{{ profile.phone }}" placeholder="+880 123456789" />
              </div>

              <div>
                <label class="label" for="website">Website</label>
                <input class="input" type="url" id="website" name="website" value="{{ profile.website }}" placeholder="https://" />
              </div>

              <div>
                <label class="label" for="linkedin">LinkedIn</label>
                <input class="input" type="url" id="linkedin" name="linkedin" value="{{ profile.linkedin }}" placeholder="https://linkedin.com/in/username" />
              </div>

              <div>
                <label class="label" for="github">GitHub</label>
                <input class="input" type="url" id="github" name="github" value="{{ profile.github }}" placeholder="https://github.com/username" />
              </div>
            </div>

            <div class="mt-4">
              <div class="flex items-center justify-between">
                <label class="label" for="bio">About Me</label>
                <span class="text-xs font-black text-slate-500"><span id="bio-count">0</span>/320</span>
              </div>
              <textarea class="input min-h-[130px]" id="bio" name="bio" rows="4" maxlength="320"
                        placeholder="2–4 lines: focus + tools + achievements...">{{ profile.bio }}</textarea>
              <p class="help">Tip: Mention your stack + 1–2 measurable wins.</p>
            </div>
          </section>

          <!-- ================= Experience ================= -->
          <section id="sec-exp" class="card gradient-teal">
            <div class="card-head">
              <div>
                <h2 class="card-title">Experience</h2>
                <p class="card-sub">Roles, internships, freelance, leadership.</p>
              </div>
              <button type="button" class="btn-primary" onclick="addForm('experience')">
                <i class="fas fa-plus mr-2"></i>Add
              </button>
            </div>

            {% if experiences_formset %}
              {{ experiences_formset.management_form }}

              <div id="experience-forms" class="space-y-4">
                {% for form in experiences_formset %}
                  <div class="item" data-form-card="1">
                    <div class="item-top">
                      <p class="item-title">Experience</p>
                      <div class="flex items-center gap-3">
                        <button type="button" class="btn-ghost-danger" onclick="removeCard(this)">Remove</button>
                      </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label class="label">Position</label>
                        {{ form.position }}
                      </div>
                      <div>
                        <label class="label">Company</label>
                        {{ form.company }}
                      </div>
                      <div>
                        <label class="label">Start Date</label>
                        {{ form.start_date }}
                      </div>
                      <div>
                        <label class="label">End Date</label>
                        {{ form.end_date }}
                      </div>
                      <div class="md:col-span-2">
                        <label class="label">Description</label>
                        {{ form.description }}
                        <p class="help">Use impact: built / improved / shipped + result.</p>
                      </div>
                    </div>

                    <div class="mt-3 flex items-center justify-between">
                      <label class="inline-flex items-center gap-2 text-sm font-semibold text-slate-700">
                        {{ form.current }} <span>Currently working here</span>
                      </label>

                      <div class="hidden">
                        {{ form.DELETE }}
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>

              <template id="experience-empty-form">
                <div class="item" data-form-card="1">
                  <div class="item-top">
                    <p class="item-title">Experience</p>
                    <button type="button" class="btn-ghost-danger" onclick="removeCard(this)">Remove</button>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label class="label">Position</label>
                      {{ experiences_formset.empty_form.position }}
                    </div>
                    <div>
                      <label class="label">Company</label>
                      {{ experiences_formset.empty_form.company }}
                    </div>
                    <div>
                      <label class="label">Start Date</label>
                      {{ experiences_formset.empty_form.start_date }}
                    </div>
                    <div>
                      <label class="label">End Date</label>
                      {{ experiences_formset.empty_form.end_date }}
                    </div>
                    <div class="md:col-span-2">
                      <label class="label">Description</label>
                      {{ experiences_formset.empty_form.description }}
                      <p class="help">Example: “Reduced API latency 35% by caching + indexing.”</p>
                    </div>
                  </div>

                  <div class="mt-3 flex items-center justify-between">
                    <label class="inline-flex items-center gap-2 text-sm font-semibold text-slate-700">
                      {{ experiences_formset.empty_form.current }} <span>Currently working here</span>
                    </label>
                    <div class="hidden">
                      {{ experiences_formset.empty_form.DELETE }}
                    </div>
                  </div>
                </div>
              </template>
            {% else %}
              <p class="text-sm text-slate-700"><b>Note:</b> pass <code>experiences_formset</code> from your view.</p>
            {% endif %}
          </section>

          <!-- ================= Education ================= -->
          <section id="sec-edu" class="card">
            <div class="card-head">
              <div>
                <h2 class="card-title">Education</h2>
                <p class="card-sub">Degree, institution, and timeline.</p>
              </div>
              <button type="button" class="btn-primary" onclick="addForm('education')">
                <i class="fas fa-plus mr-2"></i>Add
              </button>
            </div>

            {% if educations_formset %}
              {{ educations_formset.management_form }}

              <div id="education-forms" class="space-y-4">
                {% for form in educations_formset %}
                  <div class="item bg-soft" data-form-card="1">
                    <div class="item-top">
                      <p class="item-title">Education</p>
                      <button type="button" class="btn-ghost-danger" onclick="removeCard(this)">Remove</button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label class="label">Degree</label>
                        {{ form.degree }}
                      </div>
                      <div>
                        <label class="label">Institution</label>
                        {{ form.institution }}
                      </div>
                      <div>
                        <label class="label">Start Date</label>
                        {{ form.start_date }}
                      </div>
                      <div>
                        <label class="label">End Date</label>
                        {{ form.end_date }}
                      </div>
                    </div>

                    <div class="mt-3 flex items-center justify-between">
                      <label class="inline-flex items-center gap-2 text-sm font-semibold text-slate-700">
                        {{ form.current }} <span>Currently studying</span>
                      </label>
                      <div class="hidden">
                        {{ form.DELETE }}
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>

              <template id="education-empty-form">
                <div class="item bg-soft" data-form-card="1">
                  <div class="item-top">
                    <p class="item-title">Education</p>
                    <button type="button" class="btn-ghost-danger" onclick="removeCard(this)">Remove</button>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label class="label">Degree</label>
                      {{ educations_formset.empty_form.degree }}
                    </div>
                    <div>
                      <label class="label">Institution</label>
                      {{ educations_formset.empty_form.institution }}
                    </div>
                    <div>
                      <label class="label">Start Date</label>
                      {{ educations_formset.empty_form.start_date }}
                    </div>
                    <div>
                      <label class="label">End Date</label>
                      {{ educations_formset.empty_form.end_date }}
                    </div>
                  </div>

                  <div class="mt-3 flex items-center justify-between">
                    <label class="inline-flex items-center gap-2 text-sm font-semibold text-slate-700">
                      {{ educations_formset.empty_form.current }} <span>Currently studying</span>
                    </label>
                    <div class="hidden">
                      {{ educations_formset.empty_form.DELETE }}
                    </div>
                  </div>
                </div>
              </template>
            {% else %}
              <p class="text-sm text-slate-700"><b>Note:</b> pass <code>educations_formset</code> from your view.</p>
            {% endif %}
          </section>

          <!-- ================= Skills ================= -->
          <section id="sec-skill" class="card gradient-sky">
            <div class="card-head">
              <div>
                <h2 class="card-title">Skills</h2>
                <p class="card-sub">Skill name + proficiency + percentage.</p>
              </div>
              <button type="button" class="btn-primary" onclick="addForm('skill')">
                <i class="fas fa-plus mr-2"></i>Add
              </button>
            </div>

            {% if skills_formset %}
              {{ skills_formset.management_form }}

              <div id="skill-forms" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {% for form in skills_formset %}
                  <div class="item" data-form-card="1">
                    <div class="item-top">
                      <p class="item-title">Skill</p>
                      <button type="button" class="btn-ghost-danger" onclick="removeCard(this)">Remove</button>
                    </div>

                    <div class="space-y-3">
                      <div>
                        <label class="label">Skill Name</label>
                        {{ form.name }}
                      </div>
                      <div class="grid grid-cols-2 gap-3">
                        <div>
                          <label class="label">Proficiency</label>
                          {{ form.proficiency }}
                        </div>
                        <div>
                          <label class="label">Percentage</label>
                          {{ form.percentage }}
                        </div>
                      </div>
                      <div class="hidden">
                        {{ form.DELETE }}
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>

              <template id="skill-empty-form">
                <div class="item" data-form-card="1">
                  <div class="item-top">
                    <p class="item-title">Skill</p>
                    <button type="button" class="btn-ghost-danger" onclick="removeCard(this)">Remove</button>
                  </div>

                  <div class="space-y-3">
                    <div>
                      <label class="label">Skill Name</label>
                      {{ skills_formset.empty_form.name }}
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                      <div>
                        <label class="label">Proficiency</label>
                        {{ skills_formset.empty_form.proficiency }}
                      </div>
                      <div>
                        <label class="label">Percentage</label>
                        {{ skills_formset.empty_form.percentage }}
                      </div>
                    </div>
                    <div class="hidden">
                      {{ skills_formset.empty_form.DELETE }}
                    </div>
                  </div>
                </div>
              </template>
            {% else %}
              <p class="text-sm text-slate-700"><b>Note:</b> pass <code>skills_formset</code> from your view.</p>
            {% endif %}
          </section>

          <!-- ================= Projects ================= -->
          <section id="sec-proj" class="card">
            <div class="card-head">
              <div>
                <h2 class="card-title">Projects</h2>
                <p class="card-sub">Add project + live/GitHub link.</p>
              </div>
              <button type="button" class="btn-primary" onclick="addForm('project')">
                <i class="fas fa-plus mr-2"></i>Add
              </button>
            </div>

            {% if projects_formset %}
              {{ projects_formset.management_form }}

              <div id="project-forms" class="space-y-4">
                {% for form in projects_formset %}
                  <div class="item bg-soft" data-form-card="1">
                    <div class="item-top">
                      <p class="item-title">Project</p>
                      <button type="button" class="btn-ghost-danger" onclick="removeCard(this)">Remove</button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div class="md:col-span-2">
                        <label class="label">Title</label>
                        {{ form.title }}
                      </div>
                      <div class="md:col-span-2">
                        <label class="label">Description</label>
                        {{ form.description }}
                      </div>
                      <div>
                        <label class="label">Project URL</label>
                        {{ form.project_url }}
                      </div>
                      <div>
                        <label class="label">GitHub URL</label>
                        {{ form.github_url }}
                      </div>
                    </div>

                    <div class="hidden">
                      {{ form.DELETE }}
                    </div>
                  </div>
                {% endfor %}
              </div>

              <template id="project-empty-form">
                <div class="item bg-soft" data-form-card="1">
                  <div class="item-top">
                    <p class="item-title">Project</p>
                    <button type="button" class="btn-ghost-danger" onclick="removeCard(this)">Remove</button>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                      <label class="label">Title</label>
                      {{ projects_formset.empty_form.title }}
                    </div>
                    <div class="md:col-span-2">
                      <label class="label">Description</label>
                      {{ projects_formset.empty_form.description }}
                    </div>
                    <div>
                      <label class="label">Project URL</label>
                      {{ projects_formset.empty_form.project_url }}
                    </div>
                    <div>
                      <label class="label">GitHub URL</label>
                      {{ projects_formset.empty_form.github_url }}
                    </div>
                  </div>

                  <div class="hidden">
                    {{ projects_formset.empty_form.DELETE }}
                  </div>
                </div>
              </template>
            {% else %}
              <p class="text-sm text-slate-700"><b>Note:</b> pass <code>projects_formset</code> from your view.</p>
            {% endif %}
          </section>

          <!-- ================= Certificates ================= -->
          <section id="sec-cert" class="card gradient-indigo">
            <div class="card-head">
              <div>
                <h2 class="card-title">Certificates</h2>
                <p class="card-sub">Issuer + credential link.</p>
              </div>
              <button type="button" class="btn-primary" onclick="addForm('certificate')">
                <i class="fas fa-plus mr-2"></i>Add
              </button>
            </div>

            {% if certificates_formset %}
              {{ certificates_formset.management_form }}

              <div id="certificate-forms" class="space-y-4">
                {% for form in certificates_formset %}
                  <div class="item" data-form-card="1">
                    <div class="item-top">
                      <p class="item-title">Certificate</p>
                      <button type="button" class="btn-ghost-danger" onclick="removeCard(this)">Remove</button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div class="md:col-span-2">
                        <label class="label">Title</label>
                        {{ form.title }}
                      </div>
                      <div>
                        <label class="label">Issuing Organization</label>
                        {{ form.issuing_organization }}
                      </div>
                      <div>
                        <label class="label">Credential URL</label>
                        {{ form.credential_url }}
                      </div>
                    </div>

                    <div class="hidden">
                      {{ form.DELETE }}
                    </div>
                  </div>
                {% endfor %}
              </div>

              <template id="certificate-empty-form">
                <div class="item" data-form-card="1">
                  <div class="item-top">
                    <p class="item-title">Certificate</p>
                    <button type="button" class="btn-ghost-danger" onclick="removeCard(this)">Remove</button>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                      <label class="label">Title</label>
                      {{ certificates_formset.empty_form.title }}
                    </div>
                    <div>
                      <label class="label">Issuing Organization</label>
                      {{ certificates_formset.empty_form.issuing_organization }}
                    </div>
                    <div>
                      <label class="label">Credential URL</label>
                      {{ certificates_formset.empty_form.credential_url }}
                    </div>
                  </div>

                  <div class="hidden">
                    {{ certificates_formset.empty_form.DELETE }}
                  </div>
                </div>
              </template>
            {% else %}
              <p class="text-sm text-slate-700"><b>Note:</b> pass <code>certificates_formset</code> from your view.</p>
            {% endif %}
          </section>

          <!-- ================= Sticky Actions (better usability) ================= -->
          <div class="sticky-actions">
            <div class="flex flex-col md:flex-row gap-3">
              <button type="submit" class="btn-save flex-1">
                <i class="fas fa-save"></i>
                Save Changes
              </button>
              <a href="{% url 'app:profile' %}" class="btn-cancel flex-1">
                <i class="fas fa-arrow-left"></i>
                Cancel
              </a>
            </div>
            <p class="text-xs text-slate-500 mt-2">
              Tip: Save after big edits. Draft status updates automatically.
            </p>
          </div>

        </form>
      </main>
    </div>
  </div>
</div>

<!-- ================= Styles (premium + calm) ================= -->
<style>
  html { scroll-behavior: smooth; }

  /* soft page bg support */
  body{
    background: linear-gradient(180deg, rgba(241,245,249,.55), rgba(255,255,255,1));
  }

  .focus-ring:focus{
    outline:none;
    box-shadow: 0 0 0 4px rgba(14,165,233,.18);
    border-color: rgba(14,165,233,.35) !important;
  }

  .pill{
    display:inline-flex;
    align-items:center;
    gap:.5rem;
    padding:.5rem .8rem;
    border-radius: 999px;
    background: rgba(255,255,255,.85);
    border: 1px solid rgba(226,232,240,.9);
    font-size: .875rem;
    font-weight: 800;
    color: rgb(30,41,59);
    transition: transform .15s ease, background .15s ease;
  }
  .pill:hover{ background: #fff; transform: translateY(-1px); }

  .card{
    border:1px solid rgba(226,232,240,.9);
    background: rgba(255,255,255,.92);
    border-radius: 1.5rem;
    padding: 1.25rem;
    box-shadow: 0 10px 35px rgba(15,23,42,.06);
  }
  @media (min-width: 768px){
    .card{ padding: 1.5rem; }
  }

  .card-head{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap: 1rem;
    margin-bottom: 1rem;
  }
  .card-title{
    font-size: 1.125rem;
    font-weight: 900;
    color: rgb(15,23,42);
    letter-spacing: -.01em;
  }
  .card-sub{
    margin-top:.25rem;
    font-size:.875rem;
    color: rgb(71,85,105);
  }

  .badge{
    font-size: .75rem;
    font-weight: 900;
    color: rgb(15,23,42);
    background: rgba(241,245,249,.85);
    border:1px solid rgba(226,232,240,.9);
    padding: .35rem .6rem;
    border-radius: 999px;
  }

  .label{
    display:block;
    font-size:.875rem;
    font-weight:800;
    color: rgb(51,65,85);
    margin-bottom:.35rem;
  }

  .help{
    margin-top:.5rem;
    font-size:.75rem;
    color: rgb(100,116,139);
  }

  .input{
    width:100%;
    padding:.85rem 1rem;
    border-radius: 1rem;
    border:1px solid rgba(226,232,240,.95);
    background: rgba(248,250,252,.95);
    outline:none;
    transition: box-shadow .15s ease, border-color .15s ease, background .15s ease, transform .15s ease;
  }
  .input:focus{
    background:#fff;
    border-color: rgba(14,165,233,.45);
    box-shadow: 0 0 0 6px rgba(14,165,233,.12);
  }
  .input::placeholder{ color: rgba(100,116,139,.75); }

  /* make selects look premium */
  select.input{
    appearance:none;
    background-image:
      linear-gradient(45deg, transparent 50%, rgba(100,116,139,.75) 50%),
      linear-gradient(135deg, rgba(100,116,139,.75) 50%, transparent 50%);
    background-position:
      calc(100% - 18px) calc(50% - 3px),
      calc(100% - 12px) calc(50% - 3px);
    background-size: 6px 6px, 6px 6px;
    background-repeat:no-repeat;
    padding-right: 2.25rem;
  }

  .mini-btn{
    display:inline-flex;
    align-items:center;
    gap:.5rem;
    padding:.55rem .8rem;
    border-radius: 1rem;
    background:#fff;
    border:1px solid rgba(226,232,240,.95);
    color: rgb(30,41,59);
    font-size:.875rem;
    font-weight: 900;
    transition: transform .15s ease, background .15s ease, box-shadow .15s ease;
  }
  .mini-btn:hover{
    background: rgba(248,250,252,.95);
    transform: translateY(-1px);
    box-shadow: 0 10px 25px rgba(15,23,42,.06);
  }

  .btn-primary{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:.75rem 1rem;
    border-radius: 1rem;
    background: rgba(2,132,199,.92);
    color:#fff;
    font-size:.875rem;
    font-weight: 900;
    border:1px solid rgba(2,132,199,.9);
    box-shadow: 0 14px 36px rgba(2,132,199,.18);
    transition: transform .15s ease, filter .15s ease, box-shadow .15s ease;
    white-space: nowrap;
  }
  .btn-primary:hover{
    transform: translateY(-1px);
    filter: brightness(1.02);
    box-shadow: 0 18px 44px rgba(2,132,199,.24);
  }

  .btn-ghost-danger{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:.45rem .7rem;
    border-radius: .9rem;
    border:1px solid rgba(244,63,94,.25);
    background: rgba(255,255,255,.8);
    color: rgb(190,18,60);
    font-size:.875rem;
    font-weight: 900;
    transition: background .15s ease, transform .15s ease;
  }
  .btn-ghost-danger:hover{
    background: rgba(244,63,94,.08);
    transform: translateY(-1px);
  }

  .btn-save{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:.6rem;
    padding: 1rem 1rem;
    border-radius: 1.25rem;
    background: rgba(2,132,199,.92);
    color:#fff;
    font-weight: 900;
    border:1px solid rgba(2,132,199,.9);
    box-shadow: 0 16px 46px rgba(2,132,199,.20);
    transition: transform .15s ease, filter .15s ease, box-shadow .15s ease;
  }
  .btn-save:hover{
    transform: translateY(-1px);
    filter: brightness(1.02);
    box-shadow: 0 20px 56px rgba(2,132,199,.26);
  }

  .btn-cancel{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:.6rem;
    padding: 1rem 1rem;
    border-radius: 1.25rem;
    background: rgba(241,245,249,.9);
    color: rgb(30,41,59);
    font-weight: 900;
    border:1px solid rgba(226,232,240,.95);
    transition: transform .15s ease, background .15s ease;
  }
  .btn-cancel:hover{
    background: rgba(226,232,240,.95);
    transform: translateY(-1px);
  }

  .item{
    border:1px solid rgba(226,232,240,.95);
    background: rgba(255,255,255,.78);
    border-radius: 1.25rem;
    padding: 1rem;
    box-shadow: 0 10px 25px rgba(15,23,42,.05);
    backdrop-filter: blur(10px);
  }
  .bg-soft{ background: rgba(248,250,252,.92); }

  .item-top{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 1rem;
    margin-bottom: .75rem;
  }
  .item-title{
    font-size:.875rem;
    font-weight: 900;
    color: rgb(15,23,42);
  }

  .gradient-teal{
    background: linear-gradient(to bottom, rgba(236,253,245,.75), rgba(255,255,255,1));
  }
  .gradient-sky{
    background: linear-gradient(to bottom, rgba(240,249,255,.85), rgba(255,255,255,1));
  }
  .gradient-indigo{
    background: linear-gradient(to bottom, rgba(238,242,255,.85), rgba(255,255,255,1));
  }

  .chip{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    font-size: 11px;
    font-weight: 900;
    padding: .25rem .55rem;
    border-radius: 999px;
    border:1px solid rgba(226,232,240,.95);
    background: rgba(248,250,252,.95);
    color: rgb(71,85,105);
    min-width: 52px;
  }

  /* Sticky actions: always available, super usable */
  .sticky-actions{
    position: sticky;
    bottom: 0;
    padding-top: .75rem;
    margin-top: .25rem;
    background: linear-gradient(180deg, rgba(255,255,255,0), rgba(255,255,255,0.92) 30%, rgba(255,255,255,1));
    backdrop-filter: blur(10px);
  }
</style>

<!-- ================= Script (formsets + premium UX) ================= -->
<script>
/* =========================================================
   IMAGE PREVIEW
========================================================= */
function previewImage(input) {
  if (!input.files || !input.files[0]) return;
  const reader = new FileReader();
  reader.onload = e => {
    const img = document.getElementById("profile-preview");
    if (img) img.src = e.target.result;
  };
  reader.readAsDataURL(input.files[0]);
}

function scrollToSection(id){
  document.getElementById(id)?.scrollIntoView({behavior:"smooth", block:"start"});
}

/* =========================================================
   DJANGO FORMSET PREFIX MAP (must match your view)
========================================================= */
const PREFIX_MAP = {
  experience: "experiences",
  education: "educations",
  skill: "skills",
  project: "projects",
  certificate: "certificates",
};

/* =========================================================
   PREMIUM STATUS (UI only)
========================================================= */
let dirty = false;
let saveTimer = null;

function setStatus(text, ok=true){
  const el = document.getElementById("save-status");
  const dot = document.getElementById("save-dot");
  if (el) el.textContent = text;

  if (dot){
    dot.classList.remove("bg-emerald-500","bg-amber-500");
    dot.classList.add(ok ? "bg-emerald-500" : "bg-amber-500");
    dot.classList.toggle("animate-pulse", !ok);
  }
}

function markDirty(){
  dirty = true;
  setStatus("Unsaved changes", false);

  clearTimeout(saveTimer);
  saveTimer = setTimeout(() => {
    dirty = false;
    setStatus("Draft ready", true);
  }, 900);
}

/* =========================================================
   APPLY STYLES to Django form widgets (formsets)
========================================================= */
function applyWidgetStyles(root){
  root.querySelectorAll("input, textarea, select").forEach(el => {
    if (el.type === "hidden") return;

    if (el.type === "checkbox"){
      el.classList.add("w-4","h-4","rounded","border-slate-300");
      return;
    }

    el.classList.add("input");
  });

  root.querySelectorAll("textarea").forEach(t => t.classList.add("min-h-[120px]"));
}

/* =========================================================
   CURRENT checkbox -> disable end_date (experience/education)
========================================================= */
function bindCurrentCheckbox(root){
  const current = root.querySelector('input[type="checkbox"][name$="current"]');
  const endDate = root.querySelector('input[name$="end_date"]');
  if (!current || !endDate) return;

  function sync(){
    endDate.disabled = current.checked;
    endDate.classList.toggle("opacity-50", current.checked);
  }
  current.addEventListener("change", () => { sync(); markDirty(); updateCompletion(); });
  sync();
}

/* =========================================================
   ADD FORM (Django-safe)
========================================================= */
function addForm(type){
  const prefix = PREFIX_MAP[type];
  if (!prefix) return;

  const container = document.getElementById(`${type}-forms`);
  const template = document.getElementById(`${type}-empty-form`);
  const totalInput = document.querySelector(`input[name="${prefix}-TOTAL_FORMS"]`);

  if (!container || !template || !totalInput){
    console.error("Formset missing for:", type);
    return;
  }

  const index = parseInt(totalInput.value, 10);
  const html = template.innerHTML.replace(/__prefix__/g, index);

  const wrap = document.createElement("div");
  wrap.innerHTML = html.trim();
  const node = wrap.firstElementChild;

  container.appendChild(node);
  totalInput.value = index + 1;

  applyWidgetStyles(node);
  bindCurrentCheckbox(node);
  bindDirtyTracking(node);

  node.scrollIntoView({behavior:"smooth", block:"start"});
  markDirty();
  updateCompletion();
}

/* =========================================================
   REMOVE CARD (Django-safe)
========================================================= */
function removeCard(btn){
  const card = btn.closest("[data-form-card]");
  if (!card) return;

  const deleteInput = card.querySelector('input[type="checkbox"][name$="-DELETE"], input[name$="-DELETE"]');

  if (deleteInput){
    if (deleteInput.type === "checkbox") deleteInput.checked = true;
    else deleteInput.value = "on";

    card.querySelectorAll("input, textarea, select").forEach(el => {
      if (el === deleteInput) return;
      el.disabled = true;
    });

    card.style.display = "none";
  } else {
    card.remove();
  }

  markDirty();
  updateCompletion();
}

/* =========================================================
   Dirty tracking
========================================================= */
function bindDirtyTracking(root=document){
  root.querySelectorAll("input, textarea, select").forEach(el => {
    if (el.type === "hidden") return;
    el.addEventListener("input", () => { markDirty(); updateCompletion(); }, {passive:true});
    el.addEventListener("change", () => { markDirty(); updateCompletion(); }, {passive:true});
  });
}

/* =========================================================
   Bio counter
========================================================= */
function syncBioCount(){
  const bio = document.getElementById("bio");
  const out = document.getElementById("bio-count");
  if (!bio || !out) return;
  out.textContent = (bio.value || "").length;
}

/* =========================================================
   Completion
========================================================= */
function setChip(name, state){
  const el = document.querySelector(`[data-chip="${name}"]`);
  if (!el) return;

  el.className = "chip";
  if (state === "ok"){
    el.style.background = "rgba(16,185,129,.10)";
    el.style.borderColor = "rgba(16,185,129,.25)";
    el.style.color = "rgb(4,120,87)";
    el.textContent = "Done";
  } else if (state === "mid"){
    el.style.background = "rgba(245,158,11,.12)";
    el.style.borderColor = "rgba(245,158,11,.25)";
    el.style.color = "rgb(180,83,9)";
    el.textContent = "Good";
  } else {
    el.style.background = "rgba(248,250,252,.95)";
    el.style.borderColor = "rgba(226,232,240,.95)";
    el.style.color = "rgb(71,85,105)";
    el.textContent = "Add";
  }
}

function visibleCount(containerId){
  const c = document.getElementById(containerId);
  if (!c) return 0;
  return [...c.children].filter(x => x.style.display !== "none").length;
}

function updateCompletion(){
  const title = (document.getElementById("title")?.value || "").trim();
  const location = (document.getElementById("location")?.value || "").trim();
  const bio = (document.getElementById("bio")?.value || "").trim();

  const exp = visibleCount("experience-forms");
  const edu = visibleCount("education-forms");
  const skl = visibleCount("skill-forms");
  const prj = visibleCount("project-forms");
  const crt = visibleCount("certificate-forms");

  let score = 0;
  if (title) score += 15;
  if (location) score += 10;
  if (bio.length >= 40) score += 15;

  score += Math.min(exp, 3) * 12;
  score += Math.min(edu, 2) * 10;
  score += Math.min(skl, 6) * 4;
  score += Math.min(prj, 3) * 6;
  score += Math.min(crt, 3) * 3;

  score = Math.min(100, Math.max(0, score));

  const bar = document.getElementById("completion-bar");
  const label = document.getElementById("completion-label");
  if (bar) bar.style.width = score + "%";
  if (label) label.textContent = score + "%";

  setChip("basic", (title && location && bio.length >= 40) ? "ok" : (title || location || bio.length >= 20) ? "mid" : "empty");
  setChip("experience", exp >= 2 ? "ok" : exp >= 1 ? "mid" : "empty");
  setChip("education", edu >= 1 ? "ok" : "empty");
  setChip("skills", skl >= 4 ? "ok" : skl >= 2 ? "mid" : "empty");
  setChip("projects", prj >= 2 ? "ok" : prj >= 1 ? "mid" : "empty");
  setChip("certificates", crt >= 1 ? "mid" : "empty");
}

/* =========================================================
   INIT
========================================================= */
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll("[data-form-card]").forEach(card => {
    applyWidgetStyles(card);
    bindCurrentCheckbox(card);
  });

  bindDirtyTracking(document);

  syncBioCount();
  document.getElementById("bio")?.addEventListener("input", syncBioCount);

  updateCompletion();

  document.getElementById("profile-form")?.addEventListener("submit", () => setStatus("Saving…", false));
});
</script>

{% endblock %}
