{% extends "base.html" %}
{% load static %}

{% block content %}
<main class="max-w-7xl mx-auto px-6 py-10">

<!-- ================= HERO ================= -->
<section class="relative bg-gradient-to-br from-blue-900 via-indigo-900 to-purple-900 rounded-3xl p-10 text-white shadow-2xl overflow-hidden mb-12">

  <div class="absolute inset-0 bg-white/10 backdrop-blur-2xl"></div>

  <div class="relative flex flex-col md:flex-row gap-8 items-center">
    <img
      src="{% if profile.profile_picture %}{{ profile.profile_picture.url }}{% else %}https://via.placeholder.com/200{% endif %}"
      class="w-40 h-40 rounded-full object-cover ring-4 ring-white/40 shadow-xl"
      alt="{{ profile_user.username }}"
    />

    <div class="flex-1 text-center md:text-left">
      <h1 class="text-4xl font-bold tracking-tight">
        {{ profile_user.get_full_name|default:profile_user.username }}
      </h1>
      <p class="text-white/80 mt-2 text-lg">
        {{ profile.title|default:"Professional Profile" }}
      </p>

      <div class="flex flex-wrap gap-6 mt-4 text-sm text-white/80 justify-center md:justify-start">
        {% if profile.location %}
        <span><i class="fas fa-map-marker-alt mr-1"></i>{{ profile.location }}</span>
        {% endif %}
        {% if profile_user.email %}
        <span><i class="fas fa-envelope mr-1"></i>{{ profile_user.email }}</span>
        {% endif %}
        {% if profile.phone %}
        <span><i class="fas fa-phone mr-1"></i>{{ profile.phone }}</span>
        {% endif %}
      </div>

      <div class="flex gap-4 mt-6 justify-center md:justify-start">
        {% if profile.github %}
        <a href="{{ profile.github }}" target="_blank" class="btn-glass"><i class="fab fa-github"></i></a>
        {% endif %}
        {% if profile.linkedin %}
        <a href="{{ profile.linkedin }}" target="_blank" class="btn-glass"><i class="fab fa-linkedin"></i></a>
        {% endif %}
        {% if profile.website %}
        <a href="{{ profile.website }}" target="_blank" class="btn-glass"><i class="fas fa-globe"></i></a>
        {% endif %}
      </div>
    </div>

    {% if is_own_profile %}
    <div class="flex flex-col gap-3">
      <a href="{% url 'app:edit_profile' %}" class="btn-primary">
        <i class="fas fa-edit mr-1"></i>Edit
      </a>

      <!-- ✅ NEW: Create CV (PDF) - client-side, no backend needed -->
      <button onclick="openCvModal()" class="btn-secondary">
        <i class="fas fa-file-pdf mr-1"></i>Create CV
      </button>

      <!-- ✅ Download CV (PDF) - becomes available after generating once in this session -->
      <button id="downloadCvBtn" onclick="downloadLastCv()" class="btn-secondary hidden">
        <i class="fas fa-download mr-1"></i>Download CV
      </button>

      <!-- ✅ Completed Share -->
      <button onclick="shareProfile()" class="btn-secondary">
        <i class="fas fa-share-alt mr-1"></i>Share
      </button>
    </div>
    {% endif %}
  </div>
</section>

<!-- ================= TABS ================= -->
<nav class="sticky top-6 z-30 mb-10">
  <div class="flex gap-2 bg-white/80 backdrop-blur-xl border border-gray-200 rounded-full p-2 shadow-lg overflow-x-auto">

    <a href="?tab=overview" class="tab {% if active_tab == 'overview' %}tab-active{% endif %}">Overview</a>
    <a href="?tab=experience" class="tab {% if active_tab == 'experience' %}tab-active{% endif %}">Experience</a>
    <a href="?tab=education" class="tab {% if active_tab == 'education' %}tab-active{% endif %}">Education</a>
    <a href="?tab=skills" class="tab {% if active_tab == 'skills' %}tab-active{% endif %}">Skills</a>
    <a href="?tab=projects" class="tab {% if active_tab == 'projects' %}tab-active{% endif %}">Projects</a>
    <a href="?tab=certificates" class="tab {% if active_tab == 'certificates' %}tab-active{% endif %}">Certificates</a>

  </div>
</nav>

<!-- ================= CONTENT ================= -->
<section class="grid grid-cols-1 lg:grid-cols-3 gap-8">

{% if active_tab == "overview" %}
<div class="lg:col-span-2 space-y-6">

  <div class="card">
    <h3 class="card-title">About Me</h3>
    <p class="text-gray-600 text-sm leading-relaxed">
      {{ profile.bio|default:"No bio added yet." }}
    </p>
  </div>

  <div class="card">
    <h3 class="card-title">Recent Experience</h3>
    {% for experience in experiences|slice:":3" %}
    <div class="mb-5">
      <h4 class="font-semibold">{{ experience.position }}</h4>
      <p class="text-blue-600 text-sm">{{ experience.company }}</p>
      <p class="text-xs text-gray-500">
        {{ experience.start_date|date:"M Y" }} -
        {% if experience.current %}Present{% else %}{{ experience.end_date|date:"M Y" }}{% endif %}
      </p>
      <p class="text-sm text-gray-600 mt-2">
        {{ experience.description|truncatewords:25 }}
      </p>
    </div>
    {% empty %}
    <p class="text-gray-400">No experience added.</p>
    {% endfor %}
  </div>
</div>

<div class="space-y-6">
  <div class="card">
    <h3 class="card-title">Top Skills</h3>
    {% for skill in skills|slice:":5" %}
    <div class="mb-3">
      <div class="flex justify-between text-sm">
        <span>{{ skill.name }}</span>
        <span>{{ skill.percentage }}%</span>
      </div>
      <div class="h-2 bg-gray-200 rounded-full mt-1">
        <div class="h-2 bg-blue-600 rounded-full" style="width: {{ skill.percentage }}%"></div>
      </div>
    </div>
    {% empty %}
    <p class="text-gray-400">No skills added.</p>
    {% endfor %}
  </div>
</div>

{% elif active_tab == "experience" %}
<div class="lg:col-span-3 card">
  <h3 class="card-title mb-6">Experience</h3>
  {% for experience in experiences %}
  <div class="border-b pb-5 mb-5">
    <h4 class="font-semibold">{{ experience.position }}</h4>
    <p class="text-blue-600">{{ experience.company }}</p>
    <p class="text-sm text-gray-500">
      {{ experience.start_date|date:"M Y" }} -
      {% if experience.current %}Present{% else %}{{ experience.end_date|date:"M Y" }}{% endif %}
    </p>
    <p class="text-gray-600 text-sm mt-2">{{ experience.description }}</p>
  </div>
  {% empty %}
  <p class="text-gray-400">No experience added.</p>
  {% endfor %}
</div>

{% elif active_tab == "education" %}
<div class="lg:col-span-3 card">
  <h3 class="card-title">Education</h3>
  {% for education in educations %}
  <div class="mb-5">
    <h4 class="font-semibold">{{ education.degree }}</h4>
    <p class="text-green-600">{{ education.institution }}</p>
    <p class="text-sm text-gray-500">
      {{ education.start_date|date:"M Y" }} -
      {% if education.current %}Present{% else %}{{ education.end_date|date:"M Y" }}{% endif %}
    </p>
  </div>
  {% empty %}
  <p class="text-gray-400">No education added.</p>
  {% endfor %}
</div>

{% elif active_tab == "skills" %}
<div class="lg:col-span-3 card">
  <h3 class="card-title">Skills</h3>
  <div class="grid md:grid-cols-2 gap-6">
    {% for skill in skills %}
    <div>
      <div class="flex justify-between text-sm mb-1">
        <span>{{ skill.name }}</span>
        <span>{{ skill.get_proficiency_display }}</span>
      </div>
      <div class="h-3 bg-gray-200 rounded-full">
        <div class="h-3 bg-blue-600 rounded-full" style="width: {{ skill.percentage }}%"></div>
      </div>
    </div>
    {% empty %}
    <p class="text-gray-400">No skills added.</p>
    {% endfor %}
  </div>
</div>

{% elif active_tab == "projects" %}
<div class="lg:col-span-3 card">
  <h3 class="card-title">Projects</h3>
  <div class="grid md:grid-cols-2 gap-6">
    {% for project in projects %}
    <div class="border rounded-xl p-4 hover:shadow-lg transition">
      <h4 class="font-semibold">{{ project.title }}</h4>
      <p class="text-sm text-gray-600 mt-2">
        {{ project.description|truncatewords:20 }}
      </p>
      <div class="flex gap-2 mt-3">
        {% if project.project_url %}
        <a href="{{ project.project_url }}" class="text-blue-600 text-sm">Live</a>
        {% endif %}
        {% if project.github_url %}
        <a href="{{ project.github_url }}" class="text-gray-700 text-sm">GitHub</a>
        {% endif %}
      </div>
    </div>
    {% empty %}
    <p class="text-gray-400">No projects added.</p>
    {% endfor %}
  </div>
</div>

{% elif active_tab == "certificates" %}
<div class="lg:col-span-3 card">
  <h3 class="card-title">Certificates</h3>
  {% for certificate in certificates %}
  <div class="flex justify-between items-center border-b py-4">
    <div>
      <p class="font-semibold">{{ certificate.title }}</p>
      <p class="text-sm text-gray-500">{{ certificate.issuing_organization }}</p>
    </div>
    {% if certificate.credential_url %}
    <a href="{{ certificate.credential_url }}" target="_blank" class="text-blue-600">
      <i class="fas fa-external-link-alt"></i>
    </a>
    {% endif %}
  </div>
  {% empty %}
  <p class="text-gray-400">No certificates added.</p>
  {% endfor %}
</div>
{% endif %}
</section>
</main>

<!-- ================= CV MODAL ================= -->
<div id="cvModal" class="modal-overlay hidden">
  <div class="modal-card">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold text-gray-900">Create CV (PDF)</h3>
      <button onclick="closeCvModal()" class="text-gray-500 hover:text-gray-900">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <p class="text-sm text-gray-600 mb-4">
      Select what you want to include. Then click <b>Generate PDF</b>.
    </p>

    <div class="grid sm:grid-cols-2 gap-3 text-sm">
      <label class="cv-check"><input type="checkbox" id="cv_about" checked> About</label>
      <label class="cv-check"><input type="checkbox" id="cv_contact" checked> Contact</label>
      <label class="cv-check"><input type="checkbox" id="cv_experience" checked> Experience</label>
      <label class="cv-check"><input type="checkbox" id="cv_education" checked> Education</label>
      <label class="cv-check"><input type="checkbox" id="cv_skills" checked> Skills</label>
      <label class="cv-check"><input type="checkbox" id="cv_projects" checked> Projects</label>
      <label class="cv-check"><input type="checkbox" id="cv_certificates" checked> Certificates</label>
    </div>

    <div class="flex gap-3 mt-6 justify-end">
      <button onclick="closeCvModal()" class="btn-secondary">
        Cancel
      </button>
      <button onclick="generateCvPdf()" class="btn-primary">
        <i class="fas fa-file-pdf mr-1"></i>Generate PDF
      </button>
    </div>

    <p class="text-xs text-gray-500 mt-4">
      Note: This generates the PDF in your browser (no server changes).
    </p>
  </div>
</div>

<!-- ================= TOAST ================= -->
<div id="toast"
     class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-4 py-2 rounded-full shadow-xl opacity-0 pointer-events-none transition duration-300 z-50">
</div>

<!-- ================= STYLES ================= -->
<style>
.tab {
  padding: 0.6rem 1.2rem;
  border-radius: 999px;
  font-size: 0.875rem;
  color: #4b5563;
  transition: 0.3s;
}
.tab:hover { color: #2563eb; }
.tab-active {
  background: white;
  color: #2563eb;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.card {
  background: rgba(255,255,255,0.85);
  backdrop-filter: blur(14px);
  border-radius: 1.25rem;
  padding: 1.75rem;
  border: 1px solid #e5e7eb;
  box-shadow: 0 10px 30px rgba(0,0,0,0.05);
}
.card-title {
  font-weight: 600;
  margin-bottom: 1rem;
  color: #1f2937;
}
.btn-glass {
  background: rgba(255,255,255,0.2);
  padding: 0.6rem;
  border-radius: 999px;
  backdrop-filter: blur(8px);
}
.btn-primary {
  background: #2563eb;
  color: white;
  padding: 0.6rem 1.2rem;
  border-radius: 999px;
}
.btn-secondary {
  background: rgba(255,255,255,0.85);
  padding: 0.6rem 1.2rem;
  border-radius: 999px;
}

/* ✅ Modal */
.modal-overlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  backdrop-filter: blur(6px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 60;
  padding: 18px;
}
.modal-card{
  width: 100%;
  max-width: 560px;
  background: rgba(255,255,255,0.95);
  border: 1px solid #e5e7eb;
  border-radius: 20px;
  padding: 18px;
  box-shadow: 0 30px 80px rgba(0,0,0,0.25);
}
.cv-check{
  display:flex;
  gap:10px;
  align-items:center;
  background: rgba(243,244,246,0.9);
  border: 1px solid #e5e7eb;
  padding: 10px 12px;
  border-radius: 14px;
}
.hidden{ display:none; }
</style>

<!-- ✅ PDF Libraries (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script>

<script>
/* ================= TOAST ================= */
function showToast(message) {
  const t = document.getElementById("toast");
  t.textContent = message;
  t.classList.remove("opacity-0");
  t.classList.add("opacity-100");
  setTimeout(() => {
    t.classList.remove("opacity-100");
    t.classList.add("opacity-0");
  }, 1800);
}

/* ================= SHARE (completed) ================= */
async function shareProfile() {
  const url = window.location.href;
  const title = document.title || "Profile";
  const text = "Check out this profile";

  try {
    if (navigator.share) {
      await navigator.share({ title, text, url });
      showToast("Shared successfully!");
      return;
    }

    if (navigator.clipboard && window.isSecureContext) {
      await navigator.clipboard.writeText(url);
      showToast("Profile link copied!");
      return;
    }

    const temp = document.createElement("input");
    temp.value = url;
    document.body.appendChild(temp);
    temp.select();
    document.execCommand("copy");
    document.body.removeChild(temp);
    showToast("Profile link copied!");
  } catch (e) {
    showToast("Could not share. Try copying the link.");
  }
}

/* ================= CV MODAL ================= */
function openCvModal() {
  document.getElementById("cvModal").classList.remove("hidden");
}
function closeCvModal() {
  document.getElementById("cvModal").classList.add("hidden");
}

/* ================= CV DATA (from Django template vars) ================= */
const CV_DATA = {
  name: `{{ profile_user.get_full_name|default:profile_user.username|escapejs }}`,
  title: `{{ profile.title|default:"Professional Profile"|escapejs }}`,
  location: `{{ profile.location|default:""|escapejs }}`,
  email: `{{ profile_user.email|default:""|escapejs }}`,
  phone: `{{ profile.phone|default:""|escapejs }}`,
  bio: `{{ profile.bio|default:"No bio added yet."|escapejs }}`,

  socials: {
    github: `{{ profile.github|default:""|escapejs }}`,
    linkedin: `{{ profile.linkedin|default:""|escapejs }}`,
    website: `{{ profile.website|default:""|escapejs }}`
  },

  experiences: [
    {% for experience in experiences %}
    {
      position: `{{ experience.position|default:""|escapejs }}`,
      company: `{{ experience.company|default:""|escapejs }}`,
      start: `{{ experience.start_date|date:"M Y"|default:""|escapejs }}`,
      end: `{% if experience.current %}Present{% else %}{{ experience.end_date|date:"M Y"|default:""|escapejs }}{% endif %}`,
      description: `{{ experience.description|default:""|escapejs }}`
    }{% if not forloop.last %},{% endif %}
    {% empty %}
    {% endfor %}
  ],

  educations: [
    {% for education in educations %}
    {
      degree: `{{ education.degree|default:""|escapejs }}`,
      institution: `{{ education.institution|default:""|escapejs }}`,
      start: `{{ education.start_date|date:"M Y"|default:""|escapejs }}`,
      end: `{% if education.current %}Present{% else %}{{ education.end_date|date:"M Y"|default:""|escapejs }}{% endif %}`
    }{% if not forloop.last %},{% endif %}
    {% empty %}
    {% endfor %}
  ],

  skills: [
    {% for skill in skills %}
    {
      name: `{{ skill.name|default:""|escapejs }}`,
      level: `{{ skill.get_proficiency_display|default:""|escapejs }}`,
      percentage: `{{ skill.percentage|default:"0"|escapejs }}`
    }{% if not forloop.last %},{% endif %}
    {% empty %}
    {% endfor %}
  ],

  projects: [
    {% for project in projects %}
    {
      title: `{{ project.title|default:""|escapejs }}`,
      description: `{{ project.description|default:""|escapejs }}`,
      live: `{{ project.project_url|default:""|escapejs }}`,
      github: `{{ project.github_url|default:""|escapejs }}`
    }{% if not forloop.last %},{% endif %}
    {% empty %}
    {% endfor %}
  ],

  certificates: [
    {% for certificate in certificates %}
    {
      title: `{{ certificate.title|default:""|escapejs }}`,
      org: `{{ certificate.issuing_organization|default:""|escapejs }}`,
      url: `{{ certificate.credential_url|default:""|escapejs }}`
    }{% if not forloop.last %},{% endif %}
    {% empty %}
    {% endfor %}
  ]
};

let LAST_CV_BLOB = null;

/* ================= CV PDF GENERATION ================= */
function pick(id){ return document.getElementById(id).checked; }

function addSectionTitle(doc, text, y) {
  doc.setFont("helvetica", "bold");
  doc.setFontSize(12);
  doc.text(text, 14, y);
  doc.setFont("helvetica", "normal");
  doc.setFontSize(10);
}

async function generateCvPdf() {
  try {
    closeCvModal();

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p", "mm", "a4");

    // Header
    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.text(CV_DATA.name || "CV", 14, 18);

    doc.setFont("helvetica", "normal");
    doc.setFontSize(11);
    doc.text((CV_DATA.title || "").toString(), 14, 25);

    let y = 34;

    // Contact
    if (pick("cv_contact")) {
      const parts = [];
      if (CV_DATA.location) parts.push(CV_DATA.location);
      if (CV_DATA.email) parts.push(CV_DATA.email);
      if (CV_DATA.phone) parts.push(CV_DATA.phone);

      const socialParts = [];
      if (CV_DATA.socials.github) socialParts.push(`GitHub: ${CV_DATA.socials.github}`);
      if (CV_DATA.socials.linkedin) socialParts.push(`LinkedIn: ${CV_DATA.socials.linkedin}`);
      if (CV_DATA.socials.website) socialParts.push(`Website: ${CV_DATA.socials.website}`);

      if (parts.length || socialParts.length) {
        addSectionTitle(doc, "CONTACT", y);
        y += 6;
        if (parts.length) {
          doc.text(parts.join(" | "), 14, y);
          y += 6;
        }
        if (socialParts.length) {
          // Split long lines automatically
          const lines = doc.splitTextToSize(socialParts.join(" | "), 180);
          doc.text(lines, 14, y);
          y += (lines.length * 5) + 2;
        }
        y += 3;
      }
    }

    // About
    if (pick("cv_about")) {
      addSectionTitle(doc, "ABOUT", y);
      y += 6;
      const aboutLines = doc.splitTextToSize(CV_DATA.bio || "", 180);
      doc.text(aboutLines, 14, y);
      y += (aboutLines.length * 5) + 6;
    }

    // Experience
    if (pick("cv_experience")) {
      addSectionTitle(doc, "EXPERIENCE", y);
      y += 4;

      const rows = (CV_DATA.experiences || []).map(e => [
        (e.position || "-"),
        (e.company || "-"),
        `${e.start || ""} - ${e.end || ""}`,
        (e.description || "")
      ]);

      if (rows.length) {
        doc.autoTable({
          startY: y,
          head: [["Position", "Company", "Duration", "Description"]],
          body: rows,
          styles: { font: "helvetica", fontSize: 9, cellPadding: 2 },
          headStyles: { fillColor: [37, 99, 235] }, // Tailwind blue-600
          columnStyles: {
            0: { cellWidth: 34 },
            1: { cellWidth: 34 },
            2: { cellWidth: 28 },
            3: { cellWidth: 74 }
          },
          margin: { left: 14, right: 14 }
        });
        y = doc.lastAutoTable.finalY + 8;
      } else {
        doc.text("No experience added.", 14, y + 6);
        y += 14;
      }
    }

    // Education
    if (pick("cv_education")) {
      addSectionTitle(doc, "EDUCATION", y);
      y += 4;

      const rows = (CV_DATA.educations || []).map(ed => [
        (ed.degree || "-"),
        (ed.institution || "-"),
        `${ed.start || ""} - ${ed.end || ""}`
      ]);

      if (rows.length) {
        doc.autoTable({
          startY: y,
          head: [["Degree", "Institution", "Duration"]],
          body: rows,
          styles: { font: "helvetica", fontSize: 9, cellPadding: 2 },
          headStyles: { fillColor: [22, 163, 74] }, // green-ish
          columnStyles: { 0: { cellWidth: 60 }, 1: { cellWidth: 70 }, 2: { cellWidth: 40 } },
          margin: { left: 14, right: 14 }
        });
        y = doc.lastAutoTable.finalY + 8;
      } else {
        doc.text("No education added.", 14, y + 6);
        y += 14;
      }
    }

    // Skills
    if (pick("cv_skills")) {
      addSectionTitle(doc, "SKILLS", y);
      y += 4;

      const rows = (CV_DATA.skills || []).map(s => [
        (s.name || "-"),
        (s.level || "-"),
        `${s.percentage || "0"}%`
      ]);

      if (rows.length) {
        doc.autoTable({
          startY: y,
          head: [["Skill", "Level", "Strength"]],
          body: rows,
          styles: { font: "helvetica", fontSize: 9, cellPadding: 2 },
          headStyles: { fillColor: [37, 99, 235] },
          columnStyles: { 0: { cellWidth: 70 }, 1: { cellWidth: 70 }, 2: { cellWidth: 30 } },
          margin: { left: 14, right: 14 }
        });
        y = doc.lastAutoTable.finalY + 8;
      } else {
        doc.text("No skills added.", 14, y + 6);
        y += 14;
      }
    }

    // Projects
    if (pick("cv_projects")) {
      addSectionTitle(doc, "PROJECTS", y);
      y += 4;

      const rows = (CV_DATA.projects || []).map(p => [
        (p.title || "-"),
        (p.description || "-"),
        (p.live ? "Live" : ""),
        (p.github ? "GitHub" : "")
      ]);

      if (rows.length) {
        doc.autoTable({
          startY: y,
          head: [["Title", "Description", "Live", "GitHub"]],
          body: rows,
          styles: { font: "helvetica", fontSize: 9, cellPadding: 2 },
          headStyles: { fillColor: [37, 99, 235] },
          columnStyles: { 0: { cellWidth: 40 }, 1: { cellWidth: 90 }, 2: { cellWidth: 20 }, 3: { cellWidth: 20 } },
          margin: { left: 14, right: 14 }
        });
        y = doc.lastAutoTable.finalY + 8;
      } else {
        doc.text("No projects added.", 14, y + 6);
        y += 14;
      }
    }

    // Certificates
    if (pick("cv_certificates")) {
      addSectionTitle(doc, "CERTIFICATES", y);
      y += 4;

      const rows = (CV_DATA.certificates || []).map(c => [
        (c.title || "-"),
        (c.org || "-"),
        (c.url ? "Link" : "")
      ]);

      if (rows.length) {
        doc.autoTable({
          startY: y,
          head: [["Title", "Organization", "Credential"]],
          body: rows,
          styles: { font: "helvetica", fontSize: 9, cellPadding: 2 },
          headStyles: { fillColor: [37, 99, 235] },
          columnStyles: { 0: { cellWidth: 70 }, 1: { cellWidth: 70 }, 2: { cellWidth: 30 } },
          margin: { left: 14, right: 14 }
        });
        y = doc.lastAutoTable.finalY + 8;
      } else {
        doc.text("No certificates added.", 14, y + 6);
        y += 14;
      }
    }

    // Save and store for "Download CV"
    const filename = `CV_${(CV_DATA.name || "Profile").replace(/\s+/g, "_")}.pdf`;
    const pdfBlob = doc.output("blob");
    LAST_CV_BLOB = pdfBlob;

    document.getElementById("downloadCvBtn").classList.remove("hidden");

    // Direct download after generation
    doc.save(filename);
    showToast("CV generated & downloaded!");
  } catch (err) {
    console.error(err);
    showToast("CV generation failed. Please try again.");
  }
}

function downloadLastCv() {
  if (!LAST_CV_BLOB) {
    showToast("Please generate your CV first.");
    return;
  }
  const url = URL.createObjectURL(LAST_CV_BLOB);
  const a = document.createElement("a");
  a.href = url;
  a.download = `CV_${(CV_DATA.name || "Profile").replace(/\s+/g, "_")}.pdf`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  showToast("CV downloaded!");
}
</script>

{% endblock %}
