{% extends 'base.html' %}
{% load static %}

{% block content %}

<!-- =========================
  ULTRA PREMIUM COURSES (NO DARK MODE)
  - Keeps your server logic EXACTLY: tabs, filters, all vs my_courses, pagination
  - Adds next-level UX (client-side only, safe):
    âœ… Instant client-side refine (this page only) + highlight matches
    âœ… Client-side sort (doesn't touch backend)
    âœ… Save/Bookmark (localStorage) + â€œSavedâ€ quick filter (UI only)
    âœ… Compare up to 3 courses (drawer, UI only)
    âœ… Better modal: focus trap, keyboard nav, deep actions (copy link)
    âœ… Toast notifications, back-to-top, image blur-up, reduced-motion support
========================= -->

<style>
  /* line clamp helpers */
  .line-clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
  .line-clamp-3{display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;}

  /* subtle appear */
  @media (prefers-reduced-motion: no-preference){
    .fade-up{opacity:0;transform:translateY(10px);animation:fadeUp .55s ease forwards;}
    @keyframes fadeUp{to{opacity:1;transform:translateY(0)}}
  }

  /* blur-up images */
  .blur-up{filter: blur(12px); transform: scale(1.04); transition: filter .35s ease, transform .35s ease;}
  .blur-up.loaded{filter: blur(0); transform: scale(1);}

  /* highlighted search hits */
  mark.hit{background: rgba(59,130,246,.16); color: inherit; padding: 0 .18em; border-radius: .45em; border: 1px solid rgba(59,130,246,.18);}

  /* toast */
  .toast{pointer-events:auto;}
</style>

<!-- ===== HERO ===== -->
<section class="px-4 pt-8 pb-6">
  <div class="container mx-auto max-w-6xl">
    <div class="relative overflow-hidden rounded-[32px] border border-slate-200 bg-white shadow-[0_22px_80px_rgba(15,23,42,0.10)]">
      <!-- background glow -->
      <div class="pointer-events-none absolute inset-0">
        <div class="absolute -top-24 -right-24 h-72 w-72 rounded-full bg-blue-200/40 blur-3xl"></div>
        <div class="absolute -bottom-28 -left-24 h-80 w-80 rounded-full bg-indigo-200/30 blur-3xl"></div>
        <div class="absolute inset-0 bg-[radial-gradient(circle_at_25%_20%,rgba(59,130,246,0.10),transparent_55%),radial-gradient(circle_at_85%_30%,rgba(99,102,241,0.10),transparent_55%)]"></div>
      </div>

      <div class="relative px-6 sm:px-8 py-8 sm:py-10">
        <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-6">
          <div class="min-w-0">
            <div class="flex items-center gap-3">
              <div class="h-12 w-12 rounded-2xl bg-gradient-to-br from-blue-600 to-indigo-600 flex items-center justify-center shadow-md">
                <span class="text-white text-xl">ğŸ“š</span>
              </div>
              <div class="min-w-0">
                <h1 class="text-2xl sm:text-3xl md:text-4xl font-extrabold tracking-tight text-slate-900 truncate">
                  {% if active_tab == 'my_courses' %}My Courses{% else %}Online Courses{% endif %}
                </h1>
                <p class="mt-2 text-slate-600 max-w-2xl">
                  {% if active_tab == 'my_courses' %}
                    Continue your learning journey and track your progress across all enrolled courses.
                  {% else %}
                    Learn new skills and advance your career with our comprehensive course catalog taught by industry experts.
                  {% endif %}
                </p>
              </div>
            </div>

            {% if active_tab == 'all' %}
            <div class="mt-5 flex flex-wrap items-center gap-2">
              <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white/70 px-3 py-1 text-xs font-extrabold text-slate-700">
                <span class="text-slate-500">Found:</span>
                <span>{{ courses.count }}</span>
              </span>
              {% if selected_category %}
              <span class="inline-flex items-center gap-2 rounded-full border border-blue-200 bg-blue-50 px-3 py-1 text-xs font-extrabold text-blue-700">
                ğŸ—‚ï¸ {{ selected_category }}
              </span>
              {% endif %}
              {% if selected_difficulty %}
              <span class="inline-flex items-center gap-2 rounded-full border border-indigo-200 bg-indigo-50 px-3 py-1 text-xs font-extrabold text-indigo-700">
                ğŸ¯ {{ selected_difficulty }}
              </span>
              {% endif %}
              {% if selected_price %}
              <span class="inline-flex items-center gap-2 rounded-full border border-amber-200 bg-amber-50 px-3 py-1 text-xs font-extrabold text-amber-800">
                ğŸ’³ {{ selected_price }}
              </span>
              {% endif %}
            </div>
            {% endif %}
          </div>

          <!-- Tabs -->
          <div class="w-full lg:w-auto">
            <div class="rounded-3xl border border-slate-200 bg-white/70 backdrop-blur p-2 shadow-sm">
              <div class="flex items-center gap-2 justify-center">
                <a href="?tab=all{% if search_query %}&q={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_difficulty %}&difficulty={{ selected_difficulty }}{% endif %}{% if selected_price %}&price={{ selected_price }}{% endif %}"
                   class="inline-flex items-center gap-2 px-5 py-2.5 rounded-2xl text-sm font-extrabold transition
                          {% if active_tab == 'all' %}bg-blue-50 text-blue-800 border border-blue-200{% else %}bg-slate-50 text-slate-700 border border-slate-200 hover:bg-slate-100{% endif %}">
                  <span>ğŸŒ</span> All Courses
                </a>

                {% if user.is_authenticated %}
                <a href="?tab=my_courses"
                   class="inline-flex items-center gap-2 px-5 py-2.5 rounded-2xl text-sm font-extrabold transition
                          {% if active_tab == 'my_courses' %}bg-blue-50 text-blue-800 border border-blue-200{% else %}bg-slate-50 text-slate-700 border border-slate-200 hover:bg-slate-100{% endif %}">
                  <span>ğŸ“</span> My Courses
                </a>
                {% endif %}
              </div>
            </div>

            <p class="mt-2 text-center text-xs text-slate-500">
              Tip: Press <span class="font-extrabold text-slate-700">/</span> to focus search â€¢ Press <span class="font-extrabold text-slate-700">Esc</span> to close modal
            </p>

            {% if active_tab == 'all' %}
            <!-- client-only controls row -->
            <div class="mt-3 rounded-3xl border border-slate-200 bg-white/70 backdrop-blur p-3 shadow-sm">
              <div class="flex flex-wrap items-center gap-2 justify-center">
                <button id="savedOnlyBtn" type="button"
                        class="inline-flex items-center gap-2 rounded-2xl border border-slate-200 bg-white px-4 py-2 text-xs font-extrabold text-slate-700 hover:bg-slate-50 transition focus:outline-none focus:ring-4 focus:ring-blue-100">
                  ğŸ”– Saved <span id="savedCountPill" class="ml-1 inline-flex items-center justify-center rounded-full bg-slate-100 border border-slate-200 px-2 py-0.5 text-[11px]">0</span>
                </button>

                <div class="h-9 w-px bg-slate-200 mx-1 hidden sm:block"></div>

                <label class="inline-flex items-center gap-2 rounded-2xl border border-slate-200 bg-white px-4 py-2 text-xs font-extrabold text-slate-700">
                  â†• Sort
                  <select id="clientSort"
                          class="ml-1 bg-transparent text-xs font-extrabold text-slate-800 focus:outline-none">
                    <option value="relevance">Relevance</option>
                    <option value="rating_desc">Rating (high)</option>
                    <option value="students_desc">Students (high)</option>
                    <option value="price_asc">Price (low)</option>
                    <option value="price_desc">Price (high)</option>
                  </select>
                </label>

                <div class="h-9 w-px bg-slate-200 mx-1 hidden sm:block"></div>

                <button id="compareOpenBtn" type="button"
                        class="inline-flex items-center gap-2 rounded-2xl border border-slate-200 bg-white px-4 py-2 text-xs font-extrabold text-slate-700 hover:bg-slate-50 transition focus:outline-none focus:ring-4 focus:ring-blue-100">
                  ğŸ§© Compare <span id="compareCountPill" class="ml-1 inline-flex items-center justify-center rounded-full bg-slate-100 border border-slate-200 px-2 py-0.5 text-[11px]">0</span>
                </button>

                <span id="clientHint" class="hidden md:inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-extrabold text-slate-700">
                  âš¡ Instant refine (this page)
                </span>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ===== SEARCH & FILTERS (All courses) ===== -->
{% if active_tab == 'all' and show_filters %}
<section class="px-4">
  <div class="container mx-auto max-w-6xl">
    <div class="sticky top-2 z-10">
      <div class="rounded-[28px] border border-slate-200 bg-white/80 backdrop-blur shadow-sm px-4 sm:px-6 py-5">
        <form method="GET" action="{% url 'app:course_list' %}">
          <input type="hidden" name="tab" value="{{ active_tab }}"/>

          <div class="grid grid-cols-1 lg:grid-cols-12 gap-3">
            <!-- Search -->
            <div class="lg:col-span-6">
              <div class="relative">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">âŒ•</span>
                <input id="searchInput" type="text" name="q" placeholder="Search courses, instructors or skills"
                       value="{{ search_query }}"
                       class="w-full rounded-2xl border border-slate-200 bg-white pl-10 pr-28 py-3 text-sm font-semibold text-slate-800 placeholder:text-slate-400 shadow-sm focus:outline-none focus:ring-4 focus:ring-blue-100" />
                <button type="submit"
                        class="absolute right-2 top-1/2 -translate-y-1/2 rounded-xl bg-gradient-to-r from-blue-600 to-indigo-600 px-4 py-2 text-sm font-extrabold text-white shadow-md hover:shadow-lg transition focus:outline-none focus:ring-4 focus:ring-blue-200">
                  Search
                </button>
              </div>

              <!-- Client-only instant refine note -->
              <div class="mt-2 flex items-center justify-between gap-2">
                <p class="text-xs text-slate-500">
                  Instant refine happens while you type (this page). Server search happens on Submit.
                </p>
                <button id="clearClientRefine" type="button"
                        class="text-xs font-extrabold text-blue-700 hover:text-blue-800">
                  Clear refine
                </button>
              </div>
            </div>

            <!-- Category -->
            <div class="lg:col-span-2">
              <select name="category"
                      class="w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 text-sm font-extrabold text-slate-800 shadow-sm focus:outline-none focus:ring-4 focus:ring-blue-100"
                      onchange="this.form.submit()">
                <option value="">All categories</option>
                {% for category in categories %}
                <option value="{{ category.name }}" {% if selected_category == category.name %}selected{% endif %}>
                  {{ category.name }}
                </option>
                {% endfor %}
              </select>
            </div>

            <!-- Difficulty -->
            <div class="lg:col-span-2">
              <select name="difficulty"
                      class="w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 text-sm font-extrabold text-slate-800 shadow-sm focus:outline-none focus:ring-4 focus:ring-blue-100"
                      onchange="this.form.submit()">
                <option value="">All levels</option>
                {% for difficulty_code, difficulty_name in difficulty_levels %}
                <option value="{{ difficulty_code }}" {% if selected_difficulty == difficulty_code %}selected{% endif %}>
                  {{ difficulty_name }}
                </option>
                {% endfor %}
              </select>
            </div>

            <!-- Price -->
            <div class="lg:col-span-2">
              <select name="price"
                      class="w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 text-sm font-extrabold text-slate-800 shadow-sm focus:outline-none focus:ring-4 focus:ring-blue-100"
                      onchange="this.form.submit()">
                <option value="">All prices</option>
                <option value="free" {% if selected_price == 'free' %}selected{% endif %}>Free</option>
                <option value="under_1000" {% if selected_price == 'under_1000' %}selected{% endif %}>Under 1000 Tk</option>
                <option value="over_1000" {% if selected_price == 'over_1000' %}selected{% endif %}>Over 1000 Tk</option>
              </select>
            </div>
          </div>

          <div class="mt-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
            <div class="text-xs text-slate-500">
              Filters apply instantly when changed. Search uses button or Enter.
            </div>

            <a href="{% url 'app:course_list' %}?tab=all"
               class="inline-flex items-center justify-center gap-2 rounded-2xl border border-slate-200 bg-white px-4 py-2 text-xs font-extrabold text-slate-700 hover:bg-slate-50 transition focus:outline-none focus:ring-4 focus:ring-blue-100">
              âœ• Clear Filters
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>
{% endif %}

<!-- ===== CONTENT ===== -->
<section class="px-4 pb-14 pt-8">
  <div class="container mx-auto max-w-6xl">

    {% if active_tab == 'all' %}
      <!-- Results Count -->
      <div class="mb-5 flex flex-wrap items-center justify-between gap-3">
        <p class="text-sm text-slate-600">
          <span class="font-extrabold text-slate-900" id="serverCount">{{ courses.count }}</span>
          <span id="serverCountLabel">course{% if courses.count != 1 %}s{% endif %} found</span>
          <span id="clientCountWrap" class="hidden">
            â€¢ <span class="font-extrabold text-slate-900" id="clientCount">0</span>
            <span class="text-slate-600">shown (refined)</span>
          </span>
        </p>

        <div class="flex items-center gap-2">
          <span class="hidden sm:inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-extrabold text-slate-700">
            âœ¨ Premium catalog view
          </span>
          <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-extrabold text-slate-700">
            ğŸ§  Smart UX
          </span>
        </div>
      </div>

      <div id="coursesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for course in courses %}
        <!-- Course Card -->
        <article
          class="courseCard fade-up group relative overflow-hidden rounded-[28px] border border-slate-200 bg-white shadow-sm hover:shadow-[0_22px_70px_rgba(15,23,42,0.12)] transition"
          data-title="{{ course.title|default:''|lower }}"
          data-instructor="{{ course.instructor|default:''|lower }}"
          data-category="{{ course.category.name|default:''|lower }}"
          data-rating="{{ course.rating|default:0 }}"
          data-students="{{ course.students_count|default:0 }}"
          data-price="{{ course.price|default:0 }}"
          data-course-id="{{ course.id }}"
          style="animation-delay: {{ forloop.counter0|add:1 }}0ms;"
        >
          <!-- thumbnail -->
          <div class="relative h-44 overflow-hidden">
            <img
              src="{% if course.thumbnail %}{{ course.thumbnail.url }}{% else %}https://via.placeholder.com/400x250?text={{ course.title|slice:':10' }}{% endif %}"
              alt="{{ course.title }}"
              class="blur-up h-full w-full object-cover"
              loading="lazy"
            />
            <div class="pointer-events-none absolute inset-0 bg-gradient-to-t from-slate-950/45 via-slate-950/0 to-slate-950/0"></div>

            <!-- top actions -->
            <div class="absolute top-3 right-3 flex items-center gap-2">
              <!-- save -->
              <button
                type="button"
                class="saveBtn inline-flex items-center justify-center h-10 w-10 rounded-2xl bg-white/90 border border-slate-200 shadow-sm hover:bg-white transition focus:outline-none focus:ring-4 focus:ring-blue-100"
                aria-label="Save course"
                data-course-id="{{ course.id }}"
                data-course-title="{{ course.title|escape }}"
              >ğŸ”–</button>

              <!-- compare -->
              <button
                type="button"
                class="compareBtn inline-flex items-center justify-center h-10 w-10 rounded-2xl bg-white/90 border border-slate-200 shadow-sm hover:bg-white transition focus:outline-none focus:ring-4 focus:ring-blue-100"
                aria-label="Add to compare"
                data-course-id="{{ course.id }}"
                data-course-title="{{ course.title|escape }}"
                data-course-instructor="{{ course.instructor|escape }}"
                data-course-category="{{ course.category.name|escape }}"
                data-course-difficulty="{{ course.get_difficulty_display|escape }}"
                data-course-rating="{{ course.rating }}"
                data-course-rating-count="{{ course.rating_count }}"
                data-course-students="{{ course.students_count }}"
                data-course-duration="{{ course.duration_weeks }}"
                data-course-lessons="{{ course.lessons_count }}"
                data-course-price="{% if course.price == 0 %}Free{% else %}{{ course.price }} Tk{% endif %}"
                data-course-thumb="{% if course.thumbnail %}{{ course.thumbnail.url }}{% else %}https://via.placeholder.com/900x500?text={{ course.title|slice:':10' }}{% endif %}"
              >ğŸ§©</button>

              <!-- quick view -->
              <button
                type="button"
                class="quickViewBtn inline-flex items-center justify-center h-10 w-10 rounded-2xl bg-white/90 border border-slate-200 shadow-sm hover:bg-white transition focus:outline-none focus:ring-4 focus:ring-blue-100"
                aria-label="Quick view"
                data-course-id="{{ course.id }}"
                data-course-title="{{ course.title|escape }}"
                data-course-instructor="{{ course.instructor|escape }}"
                data-course-category="{{ course.category.name|escape }}"
                data-course-difficulty="{{ course.get_difficulty_display|escape }}"
                data-course-rating="{{ course.rating }}"
                data-course-rating-count="{{ course.rating_count }}"
                data-course-students="{{ course.students_count }}"
                data-course-duration="{{ course.duration_weeks }}"
                data-course-lessons="{{ course.lessons_count }}"
                data-course-price="{% if course.price == 0 %}Free{% else %}{{ course.price }} Tk{% endif %}"
                data-course-thumb="{% if course.thumbnail %}{{ course.thumbnail.url }}{% else %}https://via.placeholder.com/900x500?text={{ course.title|slice:':10' }}{% endif %}"
              >ğŸ‘ï¸</button>
            </div>

            <!-- badges -->
            <div class="absolute left-3 bottom-3 flex flex-wrap items-center gap-2">
              <span class="px-3 py-1 text-[11px] font-extrabold rounded-full border border-white/30 bg-white/90 text-slate-800">
                {{ course.category.name }}
              </span>
              <span class="px-3 py-1 text-[11px] font-extrabold rounded-full border border-white/30 bg-white/90 text-slate-800">
                {{ course.get_difficulty_display }}
              </span>
            </div>
          </div>

          <!-- body -->
          <div class="p-5">
            <h3 class="courseTitle text-base font-extrabold tracking-tight text-slate-900 line-clamp-2">
              {{ course.title }}
            </h3>

            <div class="mt-3 flex items-center gap-3">
              <img
                src="{% if course.instructor_photo %}{{ course.instructor_photo.url }}{% else %}https://via.placeholder.com/60x60?text={{ course.instructor|slice:':2' }}{% endif %}"
                alt="{{ course.instructor }}"
                class="h-9 w-9 rounded-2xl object-cover border border-slate-200"
                loading="lazy"
              />
              <div class="min-w-0">
                <p class="courseInstructor text-sm font-extrabold text-slate-800 truncate">{{ course.instructor }}</p>
                <p class="text-xs text-slate-500">Instructor</p>
              </div>
            </div>

            <div class="mt-4 grid grid-cols-2 gap-2 text-sm">
              <div class="rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2">
                <p class="text-[11px] font-bold text-slate-500">Rating</p>
                <p class="mt-1 font-extrabold text-slate-900">â­ {{ course.rating }} <span class="text-slate-500 font-bold">({{ course.rating_count }})</span></p>
              </div>
              <div class="rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2">
                <p class="text-[11px] font-bold text-slate-500">Students</p>
                <p class="mt-1 font-extrabold text-slate-900">ğŸ‘¥ {{ course.students_count }}</p>
              </div>
              <div class="rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2">
                <p class="text-[11px] font-bold text-slate-500">Duration</p>
                <p class="mt-1 font-extrabold text-slate-900">â± {{ course.duration_weeks }} Weeks</p>
              </div>
              <div class="rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2">
                <p class="text-[11px] font-bold text-slate-500">Lessons</p>
                <p class="mt-1 font-extrabold text-slate-900">ğŸ“Œ {{ course.lessons_count }} Class</p>
              </div>
            </div>

            <div class="mt-5 flex items-center justify-between gap-3">
              <span class="inline-flex items-center gap-2 rounded-2xl bg-gradient-to-r from-blue-600 to-indigo-600 px-3 py-2 text-sm font-extrabold text-white shadow-sm">
                ğŸ·ï¸ {% if course.price == 0 %}Free{% else %}{{ course.price }} Tk{% endif %}
              </span>

              {% if user.is_authenticated %}
                <a href="{% url 'app:enroll_course' course.id %}"
                   class="inline-flex items-center justify-center rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm font-extrabold text-slate-800 hover:bg-slate-50 transition focus:outline-none focus:ring-4 focus:ring-blue-100">
                  Enroll â†’
                </a>
              {% else %}
                <a href="{% url 'login' %}?next={% url 'app:course_detail' course.id %}"
                   class="inline-flex items-center justify-center rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm font-extrabold text-slate-800 hover:bg-slate-50 transition focus:outline-none focus:ring-4 focus:ring-blue-100">
                  Enroll â†’
                </a>
              {% endif %}
            </div>

            <div class="mt-4 flex items-center justify-between text-xs text-slate-500">
              <span class="inline-flex items-center gap-2">
                <span class="h-7 w-7 rounded-xl border border-slate-200 bg-slate-50 inline-flex items-center justify-center">ğŸ§¾</span>
                <span class="courseMeta">{{ course.category.name }} â€¢ {{ course.get_difficulty_display }}</span>
              </span>
              <button type="button"
                      class="copyLinkBtn font-extrabold text-blue-700 hover:text-blue-800"
                      data-url="{% url 'app:course_detail' course.id %}">
                Copy link
              </button>
            </div>
          </div>
        </article>
        {% empty %}
        <div class="col-span-full">
          <div class="rounded-[28px] border border-dashed border-slate-200 bg-white p-12 text-center shadow-sm">
            <div class="text-4xl">ğŸ“š</div>
            <h3 class="mt-4 text-lg font-extrabold text-slate-900">No courses found</h3>
            <p class="mt-1 text-sm text-slate-600">Try adjusting your search criteria or clear filters</p>
            <a href="{% url 'app:course_list' %}?tab=all"
               class="mt-6 inline-flex items-center justify-center gap-2 rounded-2xl bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-3 text-sm font-extrabold text-white shadow-md hover:shadow-lg transition focus:outline-none focus:ring-4 focus:ring-blue-200">
              View All Courses
            </a>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Client-only empty state (refine) -->
      <div id="clientEmpty" class="hidden mt-8">
        <div class="rounded-[28px] border border-dashed border-slate-200 bg-white p-10 text-center shadow-sm">
          <div class="text-4xl">ğŸ”</div>
          <h3 class="mt-4 text-lg font-extrabold text-slate-900">No matches on this page</h3>
          <p class="mt-1 text-sm text-slate-600">Clear refine or use server Search for full results.</p>
          <div class="mt-6 flex flex-wrap items-center justify-center gap-2">
            <button id="resetRefineBtn"
              class="inline-flex items-center justify-center gap-2 rounded-2xl bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-3 text-sm font-extrabold text-white shadow-md hover:shadow-lg transition focus:outline-none focus:ring-4 focus:ring-blue-200">
              Clear refine
            </button>
          </div>
        </div>
      </div>

    {% elif active_tab == 'my_courses' %}
      {% if courses_with_progress %}
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-6xl mx-auto">
        {% for course_data in courses_with_progress %}
        <article class="group relative overflow-hidden rounded-[28px] border border-slate-200 bg-white shadow-sm hover:shadow-[0_22px_70px_rgba(15,23,42,0.12)] transition">
          <div class="relative h-40 overflow-hidden">
            <img
              src="{% if course_data.course.thumbnail %}{{ course_data.course.thumbnail.url }}{% else %}https://via.placeholder.com/400x250?text={{ course_data.course.title|slice:':10' }}{% endif %}"
              alt="{{ course_data.course.title }}"
              class="blur-up h-full w-full object-cover"
              loading="lazy"
            />
            <div class="pointer-events-none absolute inset-0 bg-gradient-to-t from-slate-950/45 via-slate-950/0 to-slate-950/0"></div>
            <div class="absolute left-3 bottom-3 flex items-center gap-2">
              <span class="px-3 py-1 text-[11px] font-extrabold rounded-full border border-white/30 bg-white/90 text-slate-800">
                {{ course_data.course.get_difficulty_display }}
              </span>
              <span class="px-3 py-1 text-[11px] font-extrabold rounded-full border border-white/30 bg-white/90 text-slate-800">
                {{ course_data.course.category.name }}
              </span>
            </div>
          </div>

          <div class="p-5">
            <h3 class="text-base font-extrabold tracking-tight text-slate-900 line-clamp-2">
              {{ course_data.course.title }}
            </h3>

            <div class="mt-3 flex items-center gap-3">
              <img
                src="{% if course_data.course.instructor_photo %}{{ course_data.course.instructor_photo.url }}{% else %}https://via.placeholder.com/60x60?text={{ course_data.course.instructor|slice:':2' }}{% endif %}"
                alt="{{ course_data.course.instructor }}"
                class="h-9 w-9 rounded-2xl object-cover border border-slate-200"
                loading="lazy"
              />
              <div class="min-w-0">
                <p class="text-sm font-extrabold text-slate-800 truncate">{{ course_data.course.instructor }}</p>
                <p class="text-xs text-slate-500">Instructor</p>
              </div>
            </div>

            <!-- Progress -->
            <div class="mt-4">
              <div class="flex justify-between text-xs text-slate-600 mb-2">
                <span class="font-bold">{{ course_data.progress_percentage }}% Complete</span>
                <span class="font-bold">{{ course_data.completed_lessons }}/{{ course_data.total_lessons }} Lessons</span>
              </div>
              <div class="w-full rounded-full bg-slate-200 h-2 overflow-hidden">
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 h-2 rounded-full" style="width: {{ course_data.progress_percentage }}%"></div>
              </div>
            </div>

            {% if course_data.progress_percentage == 100 %}
            <div class="mt-4 text-center">
              <span class="inline-flex items-center gap-2 rounded-full border border-emerald-200 bg-emerald-50 px-3 py-1 text-xs font-extrabold text-emerald-700">
                ğŸ‰ Course Completed!
              </span>
            </div>
            {% endif %}

            <a href="{% if course_data.next_lesson %}{% url 'app:continue_learning' course_data.course.id %}{% else %}{% url 'app:course_detail' course_data.course.id %}{% endif %}"
               class="mt-5 w-full inline-flex items-center justify-center rounded-2xl bg-white border border-slate-200 px-4 py-3 text-sm font-extrabold text-blue-700 hover:bg-blue-50 transition focus:outline-none focus:ring-4 focus:ring-blue-100">
              {% if course_data.progress_percentage == 100 %}
                Review Course
              {% elif course_data.next_lesson %}
                Continue Learning
              {% else %}
                Start Learning
              {% endif %}
            </a>

            <div class="mt-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 text-xs text-slate-600">
              <div class="flex items-center gap-2">
                <span class="inline-flex items-center justify-center h-7 w-7 rounded-xl bg-slate-100 border border-slate-200">ğŸ“…</span>
                <span>Enrolled {{ course_data.enrollment.enrolled_date|date:"M d, Y" }}</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="inline-flex items-center justify-center h-7 w-7 rounded-xl bg-slate-100 border border-slate-200">â±</span>
                <span>Last accessed {{ course_data.enrollment.last_accessed|timesince }} ago</span>
              </div>
            </div>
          </div>
        </article>
        {% endfor %}
      </div>

      <!-- Statistics -->
      <div class="max-w-6xl mx-auto mt-10">
        <div class="rounded-[28px] border border-slate-200 bg-white shadow-sm p-6">
          <div class="flex items-start justify-between gap-3">
            <div>
              <h3 class="text-lg font-extrabold text-slate-900">Learning Statistics</h3>
              <p class="text-sm text-slate-600 mt-1">Your progress across enrolled courses</p>
            </div>
            <span class="inline-flex items-center gap-2 rounded-full border border-blue-200 bg-blue-50 px-3 py-1 text-xs font-extrabold text-blue-700">
              ğŸ“ˆ Updated
            </span>
          </div>

          <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="rounded-3xl border border-slate-200 bg-slate-50 p-5 text-center">
              <div class="text-3xl font-extrabold text-blue-700">{{ courses_with_progress|length }}</div>
              <div class="text-sm font-bold text-slate-600 mt-1">Courses Enrolled</div>
            </div>
            <div class="rounded-3xl border border-slate-200 bg-slate-50 p-5 text-center">
              <div class="text-3xl font-extrabold text-emerald-700">{{ completed_courses_count }}</div>
              <div class="text-sm font-bold text-slate-600 mt-1">Courses Completed</div>
            </div>
            <div class="rounded-3xl border border-slate-200 bg-slate-50 p-5 text-center">
              <div class="text-3xl font-extrabold text-indigo-700">{{ total_lessons_completed }}</div>
              <div class="text-sm font-bold text-slate-600 mt-1">Lessons Finished</div>
            </div>
          </div>
        </div>
      </div>

      {% else %}
      <!-- Empty My Courses -->
      <div class="max-w-3xl mx-auto">
        <div class="rounded-[28px] border border-slate-200 bg-white shadow-sm p-10 text-center">
          <div class="text-5xl">ğŸ“</div>
          <h3 class="mt-4 text-xl font-extrabold text-slate-900">No courses enrolled yet</h3>
          <p class="mt-2 text-slate-600">Start your learning journey by enrolling in courses that match your goals.</p>
          <a href="{% url 'app:course_list' %}?tab=all"
             class="mt-6 inline-flex items-center justify-center gap-2 rounded-2xl bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-3 text-sm font-extrabold text-white shadow-md hover:shadow-lg transition focus:outline-none focus:ring-4 focus:ring-blue-200">
            Browse All Courses
          </a>
        </div>

        {% if suggested_courses %}
        <div class="mt-8">
          <h4 class="text-sm font-extrabold text-slate-800 mb-3">Popular courses you might like</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            {% for suggested_course in suggested_courses %}
            <div class="rounded-3xl border border-slate-200 bg-white shadow-sm p-4 hover:shadow-md transition">
              <div class="flex items-center gap-3">
                <img
                  src="{% if suggested_course.thumbnail %}{{ suggested_course.thumbnail.url }}{% else %}https://via.placeholder.com/80x80?text={{ suggested_course.title|slice:':2' }}{% endif %}"
                  alt="{{ suggested_course.title }}"
                  class="blur-up h-12 w-12 rounded-2xl object-cover border border-slate-200"
                  loading="lazy"
                />
                <div class="min-w-0">
                  <p class="text-sm font-extrabold text-slate-900 truncate">{{ suggested_course.title }}</p>
                  <p class="text-xs text-slate-500 truncate">{{ suggested_course.instructor }}</p>
                </div>
              </div>
              <a href="{% url 'app:enroll_course' suggested_course.id %}"
                 class="mt-3 inline-flex items-center gap-2 text-sm font-extrabold text-blue-700 hover:text-blue-800">
                Enroll Now â†’
              </a>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
      </div>
      {% endif %}
    {% endif %}

    <!-- Pagination (All courses) -->
    {% if active_tab == 'all' and courses.has_other_pages %}
    <div class="flex justify-center mt-10">
      <div class="rounded-3xl border border-slate-200 bg-white shadow-sm p-2 flex flex-wrap gap-2 items-center justify-center">
        {% if courses.has_previous %}
          <a href="?page={{ courses.previous_page_number }}&tab={{ active_tab }}{% if search_query %}&q={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_difficulty %}&difficulty={{ selected_difficulty }}{% endif %}{% if selected_price %}&price={{ selected_price }}{% endif %}"
             class="px-4 py-2 rounded-2xl bg-slate-50 border border-slate-200 text-sm font-extrabold text-slate-700 hover:bg-slate-100 transition">
            â† Previous
          </a>
        {% endif %}

        {% for i in courses.paginator.page_range %}
          {% if courses.number == i %}
            <span class="px-4 py-2 rounded-2xl bg-gradient-to-r from-blue-600 to-indigo-600 text-sm font-extrabold text-white shadow-sm">
              {{ i }}
            </span>
          {% else %}
            <a href="?page={{ i }}&tab={{ active_tab }}{% if search_query %}&q={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_difficulty %}&difficulty={{ selected_difficulty }}{% endif %}{% if selected_price %}&price={{ selected_price }}{% endif %}"
               class="px-4 py-2 rounded-2xl bg-slate-50 border border-slate-200 text-sm font-extrabold text-slate-700 hover:bg-slate-100 transition">
              {{ i }}
            </a>
          {% endif %}
        {% endfor %}

        {% if courses.has_next %}
          <a href="?page={{ courses.next_page_number }}&tab={{ active_tab }}{% if search_query %}&q={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_difficulty %}&difficulty={{ selected_difficulty }}{% endif %}{% if selected_price %}&price={{ selected_price }}{% endif %}"
             class="px-4 py-2 rounded-2xl bg-slate-50 border border-slate-200 text-sm font-extrabold text-slate-700 hover:bg-slate-100 transition">
            Next â†’
          </a>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>
</section>

<!-- ===== QUICK VIEW MODAL (UI ONLY) ===== -->
<div id="qvOverlay" class="hidden fixed inset-0 z-[60]" aria-hidden="true">
  <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm"></div>

  <div class="relative mx-auto mt-10 sm:mt-16 w-[min(980px,calc(100%-24px))]">
    <div class="rounded-[28px] border border-slate-200 bg-white shadow-[0_30px_100px_rgba(15,23,42,0.25)] overflow-hidden">
      <div class="px-5 sm:px-6 py-4 border-b border-slate-200 bg-gradient-to-b from-white to-slate-50 flex items-start justify-between gap-3">
        <div class="min-w-0">
          <p class="text-sm font-extrabold text-slate-900">Course Preview</p>
          <p class="text-xs text-slate-500">Quick view (UI only)</p>
        </div>
        <button id="qvClose" class="h-10 w-10 rounded-2xl border border-slate-200 bg-white hover:bg-slate-50 transition focus:outline-none focus:ring-4 focus:ring-blue-100" aria-label="Close">âœ•</button>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-5">
        <div class="lg:col-span-2 relative">
          <img id="qvThumb" src="" alt="" class="h-56 lg:h-full w-full object-cover" />
          <div class="absolute left-4 bottom-4 flex items-center gap-2">
            <button id="qvSave"
              class="inline-flex items-center gap-2 rounded-2xl border border-slate-200 bg-white/90 px-4 py-2 text-xs font-extrabold text-slate-800 shadow-sm hover:bg-white transition focus:outline-none focus:ring-4 focus:ring-blue-100">
              ğŸ”– Save
            </button>
            <button id="qvCopy"
              class="inline-flex items-center gap-2 rounded-2xl border border-slate-200 bg-white/90 px-4 py-2 text-xs font-extrabold text-slate-800 shadow-sm hover:bg-white transition focus:outline-none focus:ring-4 focus:ring-blue-100">
              ğŸ”— Copy link
            </button>
          </div>
        </div>

        <div class="lg:col-span-3 p-5 sm:p-6">
          <div class="flex flex-wrap items-center gap-2">
            <span id="qvCategory" class="inline-flex items-center rounded-full border border-slate-200 bg-slate-50 px-3 py-1 text-xs font-extrabold text-slate-700"></span>
            <span id="qvDifficulty" class="inline-flex items-center rounded-full border border-blue-200 bg-blue-50 px-3 py-1 text-xs font-extrabold text-blue-700"></span>
            <span id="qvPrice" class="ml-auto inline-flex items-center gap-2 rounded-2xl bg-gradient-to-r from-blue-600 to-indigo-600 px-3 py-2 text-sm font-extrabold text-white shadow-sm"></span>
          </div>

          <h3 id="qvTitle" class="mt-3 text-xl font-extrabold tracking-tight text-slate-900"></h3>

          <div class="mt-3 flex items-center gap-2 text-sm text-slate-600">
            <span class="inline-flex items-center justify-center h-9 w-9 rounded-2xl bg-slate-100 border border-slate-200">ğŸ‘¤</span>
            <span class="font-extrabold text-slate-800">Instructor:</span>
            <span id="qvInstructor"></span>
          </div>

          <div class="mt-5 grid grid-cols-2 gap-3">
            <div class="rounded-2xl border border-slate-200 bg-slate-50 px-3 py-3">
              <p class="text-[11px] font-bold text-slate-500">Rating</p>
              <p id="qvRating" class="mt-1 font-extrabold text-slate-900"></p>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-slate-50 px-3 py-3">
              <p class="text-[11px] font-bold text-slate-500">Students</p>
              <p id="qvStudents" class="mt-1 font-extrabold text-slate-900"></p>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-slate-50 px-3 py-3">
              <p class="text-[11px] font-bold text-slate-500">Duration</p>
              <p id="qvDuration" class="mt-1 font-extrabold text-slate-900"></p>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-slate-50 px-3 py-3">
              <p class="text-[11px] font-bold text-slate-500">Lessons</p>
              <p id="qvLessons" class="mt-1 font-extrabold text-slate-900"></p>
            </div>
          </div>

          <div class="mt-6 flex flex-wrap items-center justify-end gap-2">
            <a id="qvDetails"
               class="inline-flex items-center justify-center gap-2 rounded-2xl border border-slate-200 bg-white px-6 py-3 text-sm font-extrabold text-slate-800 hover:bg-slate-50 transition focus:outline-none focus:ring-4 focus:ring-blue-100">
              View details â†’
            </a>
            <button id="qvOk" type="button"
              class="inline-flex items-center justify-center gap-2 rounded-2xl bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-3 text-sm font-extrabold text-white shadow-md hover:shadow-lg transition focus:outline-none focus:ring-4 focus:ring-blue-200">
              Done
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== COMPARE DRAWER (UI ONLY) ===== -->
<div id="compareDrawer" class="hidden fixed inset-0 z-[70]" aria-hidden="true">
  <div class="absolute inset-0 bg-slate-900/35 backdrop-blur-sm"></div>

  <div class="absolute right-0 top-0 h-full w-[min(520px,calc(100%-18px))] bg-white border-l border-slate-200 shadow-[0_30px_100px_rgba(15,23,42,0.25)]">
    <div class="p-5 border-b border-slate-200 bg-gradient-to-b from-white to-slate-50 flex items-center justify-between gap-3">
      <div>
        <p class="text-sm font-extrabold text-slate-900">Compare Courses</p>
        <p class="text-xs text-slate-500">Up to 3 courses (UI only)</p>
      </div>
      <button id="compareClose" class="h-10 w-10 rounded-2xl border border-slate-200 bg-white hover:bg-slate-50 transition focus:outline-none focus:ring-4 focus:ring-blue-100" aria-label="Close">âœ•</button>
    </div>

    <div class="p-5">
      <div id="compareList" class="space-y-3"></div>

      <div class="mt-5 rounded-3xl border border-slate-200 bg-slate-50 p-4">
        <p class="text-xs font-extrabold text-slate-700">Tip</p>
        <p class="text-xs text-slate-600 mt-1">
          Compare Rating, Students, Duration, and Price. Use Quick View for details.
        </p>
      </div>

      <div class="mt-5 flex items-center justify-between gap-2">
        <button id="compareClear"
          class="inline-flex items-center justify-center gap-2 rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm font-extrabold text-slate-800 hover:bg-slate-50 transition focus:outline-none focus:ring-4 focus:ring-blue-100">
          ğŸ§¹ Clear
        </button>
        <button id="compareDone"
          class="inline-flex items-center justify-center gap-2 rounded-2xl bg-gradient-to-r from-blue-600 to-indigo-600 px-5 py-3 text-sm font-extrabold text-white shadow-md hover:shadow-lg transition focus:outline-none focus:ring-4 focus:ring-blue-200">
          Done
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ===== TOASTS ===== -->
<div id="toastHost" class="fixed bottom-5 left-1/2 -translate-x-1/2 z-[80] flex flex-col gap-2 w-[min(520px,calc(100%-18px))] pointer-events-none"></div>

<!-- ===== BACK TO TOP ===== -->
<button id="backToTop" type="button"
  class="hidden fixed bottom-6 right-6 z-[75] h-12 w-12 rounded-2xl border border-slate-200 bg-white shadow-md hover:shadow-lg transition focus:outline-none focus:ring-4 focus:ring-blue-100">
  â†‘
</button>

<script>
  // ---------------------------
  // Utilities
  // ---------------------------
  const qs = (s, el=document) => el.querySelector(s);
  const qsa = (s, el=document) => [...el.querySelectorAll(s)];

  function safeJSONParse(v, fallback){
    try { return JSON.parse(v); } catch { return fallback; }
  }

  function toast(message, type='info'){
    const host = qs('#toastHost');
    if(!host) return;

    const icon = type === 'success' ? 'âœ…' : type === 'danger' ? 'âš ï¸' : 'â„¹ï¸';
    const node = document.createElement('div');
    node.className = 'toast pointer-events-auto rounded-3xl border border-slate-200 bg-white shadow-[0_16px_50px_rgba(15,23,42,0.18)] px-4 py-3 flex items-start gap-3';
    node.innerHTML = `
      <div class="h-9 w-9 rounded-2xl bg-slate-50 border border-slate-200 flex items-center justify-center">${icon}</div>
      <div class="min-w-0">
        <p class="text-sm font-extrabold text-slate-900">Notification</p>
        <p class="text-sm text-slate-600 mt-0.5">${message}</p>
      </div>
      <button class="ml-auto h-9 w-9 rounded-2xl border border-slate-200 bg-white hover:bg-slate-50 transition">âœ•</button>
    `;

    host.appendChild(node);

    const close = () => node.remove();
    qs('button', node)?.addEventListener('click', close);
    setTimeout(close, 3200);
  }

  function escapeRegExp(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }

  // ---------------------------
  // Blur-up images
  // ---------------------------
  (function(){
    qsa('img.blur-up').forEach(img => {
      const done = () => img.classList.add('loaded');
      if (img.complete) done();
      else img.addEventListener('load', done, { once: true });
    });
  })();

  // ---------------------------
  // Focus search with "/"
  // ---------------------------
  (function () {
    const input = qs('#searchInput');
    if (!input) return;

    document.addEventListener('keydown', (e) => {
      if (e.key === '/' && document.activeElement !== input && !e.ctrlKey && !e.metaKey && !e.altKey) {
        e.preventDefault();
        input.focus();
      }
    });
  })();

  // ---------------------------
  // Saved (Bookmarks) - localStorage
  // ---------------------------
  const SAVED_KEY = 'skillnet_saved_courses';
  function getSaved(){
    return new Set(safeJSONParse(localStorage.getItem(SAVED_KEY) || '[]', []));
  }
  function setSaved(set){
    localStorage.setItem(SAVED_KEY, JSON.stringify([...set]));
  }
  function updateSavedUI(){
    const saved = getSaved();
    const pill = qs('#savedCountPill');
    if (pill) pill.textContent = saved.size;

    qsa('.saveBtn').forEach(btn => {
      const id = btn.getAttribute('data-course-id');
      const isSaved = saved.has(String(id));
      btn.textContent = isSaved ? 'âœ…' : 'ğŸ”–';
      btn.setAttribute('aria-label', isSaved ? 'Saved' : 'Save course');
      btn.classList.toggle('ring-2', isSaved);
      btn.classList.toggle('ring-blue-200', isSaved);
    });
  }

  // ---------------------------
  // Client-side refine + highlight
  // ---------------------------
  function stripMarks(el){
    qsa('mark.hit', el).forEach(m => {
      const text = document.createTextNode(m.textContent);
      m.replaceWith(text);
    });
  }

  function highlight(el, query){
    stripMarks(el);
    if (!query) return;

    const q = query.trim();
    if(!q) return;

    const rx = new RegExp(escapeRegExp(q), 'ig');
    // only highlight inside title + instructor for readability
    const targets = qsa('.courseTitle, .courseInstructor', el);
    targets.forEach(t => {
      const txt = t.textContent;
      if(!txt) return;
      if(!rx.test(txt)) return;

      t.innerHTML = txt.replace(rx, (m) => `<mark class="hit">${m}</mark>`);
    });
  }

  function applyClientRefine(){
    const input = qs('#searchInput');
    const grid = qs('#coursesGrid');
    if(!input || !grid) return;

    const query = input.value.trim().toLowerCase();
    const savedOnly = grid.getAttribute('data-saved-only') === '1';
    const cards = qsa('.courseCard', grid);

    let shown = 0;
    cards.forEach(card => {
      // highlight refresh
      highlight(card, query);

      const title = card.getAttribute('data-title') || '';
      const instructor = card.getAttribute('data-instructor') || '';
      const category = card.getAttribute('data-category') || '';

      const match = !query || title.includes(query) || instructor.includes(query) || category.includes(query);

      const saved = getSaved();
      const id = String(card.getAttribute('data-course-id') || '');
      const savedOk = !savedOnly || saved.has(id);

      const visible = match && savedOk;
      card.classList.toggle('hidden', !visible);
      if (visible) shown++;
    });

    const clientWrap = qs('#clientCountWrap');
    const clientCount = qs('#clientCount');
    const empty = qs('#clientEmpty');

    const isRefining = !!query || savedOnly;
    if (clientWrap && clientCount) {
      clientWrap.classList.toggle('hidden', !isRefining);
      clientCount.textContent = String(shown);
    }
    if (empty) empty.classList.toggle('hidden', shown !== 0 || !isRefining);
  }

  // ---------------------------
  // Client-side sort (page only)
  // ---------------------------
  function applyClientSort(value){
    const grid = qs('#coursesGrid');
    if(!grid) return;

    const cards = qsa('.courseCard', grid).filter(c => !c.classList.contains('hidden')); // sort visible set
    const allCards = qsa('.courseCard', grid);

    const getNum = (card, attr) => Number(card.getAttribute(attr) || 0);

    let sorted;
    switch(value){
      case 'rating_desc':
        sorted = [...allCards].sort((a,b)=>getNum(b,'data-rating')-getNum(a,'data-rating'));
        break;
      case 'students_desc':
        sorted = [...allCards].sort((a,b)=>getNum(b,'data-students')-getNum(a,'data-students'));
        break;
      case 'price_asc':
        sorted = [...allCards].sort((a,b)=>getNum(a,'data-price')-getNum(b,'data-price'));
        break;
      case 'price_desc':
        sorted = [...allCards].sort((a,b)=>getNum(b,'data-price')-getNum(a,'data-price'));
        break;
      default:
        // "relevance" -> keep DOM order, do nothing
        return;
    }

    // Re-append in sorted order (keeps hidden state)
    sorted.forEach(card => grid.appendChild(card));
  }

  // ---------------------------
  // Quick view modal (UI only) + focus trap
  // ---------------------------
  (function () {
    const overlay = qs('#qvOverlay');
    const closeBtn = qs('#qvClose');
    const okBtn = qs('#qvOk');

    const qvThumb = qs('#qvThumb');
    const qvCategory = qs('#qvCategory');
    const qvDifficulty = qs('#qvDifficulty');
    const qvPrice = qs('#qvPrice');
    const qvTitle = qs('#qvTitle');
    const qvInstructor = qs('#qvInstructor');
    const qvRating = qs('#qvRating');
    const qvStudents = qs('#qvStudents');
    const qvDuration = qs('#qvDuration');
    const qvLessons = qs('#qvLessons');
    const qvSave = qs('#qvSave');
    const qvCopy = qs('#qvCopy');
    const qvDetails = qs('#qvDetails');

    let lastActive = null;
    let currentCourseId = null;
    let currentCourseUrl = null;

    function focusables(container){
      return qsa('a, button, input, select, textarea, [tabindex]:not([tabindex="-1"])', container)
        .filter(el => !el.disabled && !el.getAttribute('aria-hidden'));
    }

    function trapFocus(e){
      if(!overlay || overlay.classList.contains('hidden')) return;
      if(e.key !== 'Tab') return;

      const box = overlay;
      const els = focusables(box);
      if(!els.length) return;

      const first = els[0];
      const last = els[els.length - 1];

      if(e.shiftKey && document.activeElement === first){
        e.preventDefault(); last.focus();
      } else if(!e.shiftKey && document.activeElement === last){
        e.preventDefault(); first.focus();
      }
    }

    function openModal(data) {
      currentCourseId = data.id || null;

      qvThumb.src = data.thumb || '';
      qvThumb.alt = data.title || 'Course';
      qvCategory.textContent = data.category || 'â€”';
      qvDifficulty.textContent = data.difficulty || 'â€”';
      qvPrice.textContent = `ğŸ·ï¸ ${data.price || 'â€”'}`;
      qvTitle.textContent = data.title || 'Course';
      qvInstructor.textContent = data.instructor || 'â€”';
      qvRating.textContent = `â­ ${data.rating || '0'} (${data.ratingCount || '0'})`;
      qvStudents.textContent = `ğŸ‘¥ ${data.students || '0'}`;
      qvDuration.textContent = `â± ${data.duration || '0'} Weeks`;
      qvLessons.textContent = `ğŸ“Œ ${data.lessons || '0'} Class`;

      // details link (safe: same origin)
      if (data.id) {
        currentCourseUrl = `/courses/${data.id}/`;
        qvDetails?.setAttribute('href', currentCourseUrl);
      } else {
        currentCourseUrl = null;
        qvDetails?.setAttribute('href', '#');
      }

      // save button state
      if (qvSave && currentCourseId){
        const saved = getSaved();
        const isSaved = saved.has(String(currentCourseId));
        qvSave.textContent = isSaved ? 'âœ… Saved' : 'ğŸ”– Save';
      }

      lastActive = document.activeElement;
      overlay.classList.remove('hidden');
      overlay.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';

      // focus
      setTimeout(() => (closeBtn || okBtn)?.focus(), 0);
    }

    function closeModal() {
      overlay.classList.add('hidden');
      overlay.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
      if (lastActive && lastActive.focus) lastActive.focus();
    }

    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.quickViewBtn');
      if (!btn) return;

      openModal({
        id: btn.getAttribute('data-course-id'),
        title: btn.getAttribute('data-course-title'),
        instructor: btn.getAttribute('data-course-instructor'),
        category: btn.getAttribute('data-course-category'),
        difficulty: btn.getAttribute('data-course-difficulty'),
        rating: btn.getAttribute('data-course-rating'),
        ratingCount: btn.getAttribute('data-course-rating-count'),
        students: btn.getAttribute('data-course-students'),
        duration: btn.getAttribute('data-course-duration'),
        lessons: btn.getAttribute('data-course-lessons'),
        price: btn.getAttribute('data-course-price'),
        thumb: btn.getAttribute('data-course-thumb'),
      });
    });

    closeBtn?.addEventListener('click', closeModal);
    okBtn?.addEventListener('click', closeModal);

    overlay?.addEventListener('click', (e) => {
      // clicking backdrop closes
      if (e.target === overlay) closeModal();
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
      trapFocus(e);
    });

    qvSave?.addEventListener('click', () => {
      if(!currentCourseId) return;
      const saved = getSaved();
      const id = String(currentCourseId);
      if(saved.has(id)){
        saved.delete(id);
        toast('Removed from Saved', 'info');
      } else {
        saved.add(id);
        toast('Saved! You can filter Saved anytime.', 'success');
      }
      setSaved(saved);
      updateSavedUI();
      applyClientRefine();
      qvSave.textContent = saved.has(id) ? 'âœ… Saved' : 'ğŸ”– Save';
    });

    qvCopy?.addEventListener('click', async () => {
      if(!currentCourseUrl) {
        toast('Link not available', 'danger');
        return;
      }
      const full = new URL(currentCourseUrl, window.location.origin).toString();
      try{
        await navigator.clipboard.writeText(full);
        toast('Course link copied!', 'success');
      }catch{
        toast('Copy failed (browser permission).', 'danger');
      }
    });
  })();

  // ---------------------------
  // Compare drawer
  // ---------------------------
  const COMPARE_KEY = 'skillnet_compare_courses';
  function getCompare(){ return safeJSONParse(localStorage.getItem(COMPARE_KEY) || '[]', []); }
  function setCompare(list){ localStorage.setItem(COMPARE_KEY, JSON.stringify(list)); }

  function updateComparePill(){
    const pill = qs('#compareCountPill');
    if (pill) pill.textContent = String(getCompare().length);
  }

  function renderCompare(){
    const list = getCompare();
    const host = qs('#compareList');
    if(!host) return;

    host.innerHTML = '';
    if(!list.length){
      host.innerHTML = `
        <div class="rounded-3xl border border-dashed border-slate-200 bg-white p-6 text-center">
          <div class="text-3xl">ğŸ§©</div>
          <p class="mt-3 text-sm font-extrabold text-slate-900">No courses added</p>
          <p class="mt-1 text-xs text-slate-600">Tap the ğŸ§© icon on a course card.</p>
        </div>
      `;
      return;
    }

    list.forEach(item => {
      const row = document.createElement('div');
      row.className = 'rounded-3xl border border-slate-200 bg-white p-4 shadow-sm';
      row.innerHTML = `
        <div class="flex items-start gap-3">
          <img src="${item.thumb || ''}" alt="" class="h-14 w-14 rounded-2xl object-cover border border-slate-200" />
          <div class="min-w-0 flex-1">
            <p class="text-sm font-extrabold text-slate-900 line-clamp-2">${item.title || 'Course'}</p>
            <p class="text-xs text-slate-500 mt-0.5">${item.category || 'â€”'} â€¢ ${item.difficulty || 'â€”'}</p>
            <div class="mt-2 grid grid-cols-2 gap-2 text-xs">
              <div class="rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2">
                <p class="text-[11px] font-bold text-slate-500">Rating</p>
                <p class="mt-1 font-extrabold text-slate-900">â­ ${item.rating || '0'}</p>
              </div>
              <div class="rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2">
                <p class="text-[11px] font-bold text-slate-500">Students</p>
                <p class="mt-1 font-extrabold text-slate-900">ğŸ‘¥ ${item.students || '0'}</p>
              </div>
              <div class="rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2">
                <p class="text-[11px] font-bold text-slate-500">Duration</p>
                <p class="mt-1 font-extrabold text-slate-900">â± ${item.duration || '0'} w</p>
              </div>
              <div class="rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2">
                <p class="text-[11px] font-bold text-slate-500">Price</p>
                <p class="mt-1 font-extrabold text-slate-900">ğŸ·ï¸ ${item.price || 'â€”'}</p>
              </div>
            </div>
          </div>
          <button data-remove="${item.id}"
            class="h-10 w-10 rounded-2xl border border-slate-200 bg-white hover:bg-slate-50 transition focus:outline-none focus:ring-4 focus:ring-blue-100">âœ•</button>
        </div>
      `;
      host.appendChild(row);
    });

    qsa('button[data-remove]', host).forEach(btn => {
      btn.addEventListener('click', () => {
        const id = String(btn.getAttribute('data-remove'));
        const list = getCompare().filter(x => String(x.id) !== id);
        setCompare(list);
        updateComparePill();
        renderCompare();
        toast('Removed from compare', 'info');
      });
    });
  }

  function openCompare(){
    const drawer = qs('#compareDrawer');
    if(!drawer) return;
    drawer.classList.remove('hidden');
    drawer.setAttribute('aria-hidden','false');
    document.body.style.overflow = 'hidden';
    renderCompare();
  }
  function closeCompare(){
    const drawer = qs('#compareDrawer');
    if(!drawer) return;
    drawer.classList.add('hidden');
    drawer.setAttribute('aria-hidden','true');
    document.body.style.overflow = '';
  }

  // ---------------------------
  // Events
  // ---------------------------
  document.addEventListener('click', async (e) => {
    // Save button
    const saveBtn = e.target.closest('.saveBtn');
    if(saveBtn){
      const id = String(saveBtn.getAttribute('data-course-id'));
      const title = saveBtn.getAttribute('data-course-title') || 'Course';
      const saved = getSaved();
      if(saved.has(id)){
        saved.delete(id);
        toast(`Removed "${title}" from Saved`, 'info');
      } else {
        saved.add(id);
        toast(`Saved "${title}"`, 'success');
      }
      setSaved(saved);
      updateSavedUI();
      applyClientRefine();
      return;
    }

    // Compare button
    const compareBtn = e.target.closest('.compareBtn');
    if(compareBtn){
      const id = String(compareBtn.getAttribute('data-course-id'));
      let list = getCompare();

      if(list.some(x => String(x.id) === id)){
        toast('Already in compare', 'info');
        openCompare();
        return;
      }
      if(list.length >= 3){
        toast('Compare limit: 3 courses', 'danger');
        openCompare();
        return;
      }

      list.push({
        id,
        title: compareBtn.getAttribute('data-course-title'),
        instructor: compareBtn.getAttribute('data-course-instructor'),
        category: compareBtn.getAttribute('data-course-category'),
        difficulty: compareBtn.getAttribute('data-course-difficulty'),
        rating: compareBtn.getAttribute('data-course-rating'),
        students: compareBtn.getAttribute('data-course-students'),
        duration: compareBtn.getAttribute('data-course-duration'),
        lessons: compareBtn.getAttribute('data-course-lessons'),
        price: compareBtn.getAttribute('data-course-price'),
        thumb: compareBtn.getAttribute('data-course-thumb'),
      });

      setCompare(list);
      updateComparePill();
      toast('Added to compare', 'success');
      return;
    }

    // Copy link (per card)
    const copyBtn = e.target.closest('.copyLinkBtn');
    if(copyBtn){
      const path = copyBtn.getAttribute('data-url') || '';
      const full = new URL(path, window.location.origin).toString();
      try{
        await navigator.clipboard.writeText(full);
        toast('Link copied!', 'success');
      }catch{
        toast('Copy failed (browser permission).', 'danger');
      }
      return;
    }
  });

  // Saved filter toggle
  (function(){
    const btn = qs('#savedOnlyBtn');
    const grid = qs('#coursesGrid');
    if(!btn || !grid) return;

    btn.addEventListener('click', () => {
      const on = grid.getAttribute('data-saved-only') === '1';
      grid.setAttribute('data-saved-only', on ? '0' : '1');
      btn.classList.toggle('bg-blue-50', !on);
      btn.classList.toggle('border-blue-200', !on);
      btn.classList.toggle('text-blue-800', !on);
      toast(!on ? 'Showing Saved only (this page)' : 'Showing all (this page)', 'info');
      applyClientRefine();
    });
  })();

  // Client sort
  (function(){
    const sort = qs('#clientSort');
    if(!sort) return;
    sort.addEventListener('change', () => {
      applyClientSort(sort.value);
      toast(`Sorted: ${sort.options[sort.selectedIndex].text}`, 'info');
    });
  })();

  // Compare drawer open/close
  (function(){
    const openBtn = qs('#compareOpenBtn');
    const closeBtn = qs('#compareClose');
    const doneBtn = qs('#compareDone');
    const clearBtn = qs('#compareClear');
    const drawer = qs('#compareDrawer');

    openBtn?.addEventListener('click', openCompare);
    closeBtn?.addEventListener('click', closeCompare);
    doneBtn?.addEventListener('click', closeCompare);

    drawer?.addEventListener('click', (e) => {
      if(e.target === drawer) closeCompare();
    });

    clearBtn?.addEventListener('click', () => {
      setCompare([]);
      updateComparePill();
      renderCompare();
      toast('Compare cleared', 'info');
    });

    document.addEventListener('keydown', (e) => {
      if(e.key === 'Escape') closeCompare();
    });
  })();

  // Live refine while typing (all courses page only)
  (function(){
    const input = qs('#searchInput');
    const grid = qs('#coursesGrid');
    if(!input || !grid) return;

    let t = null;
    input.addEventListener('input', () => {
      window.clearTimeout(t);
      t = window.setTimeout(applyClientRefine, 60);
    });

    qs('#clearClientRefine')?.addEventListener('click', () => {
      input.value = '';
      applyClientRefine();
      input.focus();
    });

    qs('#resetRefineBtn')?.addEventListener('click', () => {
      input.value = '';
      grid.setAttribute('data-saved-only','0');
      qs('#savedOnlyBtn')?.classList.remove('bg-blue-50','border-blue-200','text-blue-800');
      applyClientRefine();
    });

    // initial
    applyClientRefine();
  })();

  // Back to top
  (function(){
    const btn = qs('#backToTop');
    if(!btn) return;

    const onScroll = () => {
      btn.classList.toggle('hidden', window.scrollY < 500);
    };
    window.addEventListener('scroll', onScroll, { passive: true });
    onScroll();

    btn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
  })();

  // Init counts UI
  updateSavedUI();
  updateComparePill();
</script>

{% endblock %}
