{% extends 'base-admin.html' %}
{% load static %}

{% block content_admin %}

<div class="min-h-screen bg-slate-50">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Hero / Header -->
    <div class="relative overflow-hidden rounded-3xl border border-slate-200 bg-white shadow-[0_18px_60px_rgba(15,23,42,0.08)]">
      <div class="pointer-events-none absolute inset-0">
        <div class="absolute -top-24 -right-24 h-72 w-72 rounded-full bg-blue-200/40 blur-3xl"></div>
        <div class="absolute -bottom-28 -left-24 h-80 w-80 rounded-full bg-indigo-200/35 blur-3xl"></div>
        <div class="absolute inset-0 bg-[radial-gradient(circle_at_20%_20%,rgba(59,130,246,0.10),transparent_55%),radial-gradient(circle_at_85%_30%,rgba(99,102,241,0.10),transparent_55%)]"></div>
      </div>

      <div class="relative px-5 sm:px-7 lg:px-8 py-6 sm:py-7">
        <div class="flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between">
          <div class="min-w-0">
            <div class="flex items-center gap-3">
              <div class="h-11 w-11 rounded-2xl bg-gradient-to-br from-blue-600 to-indigo-600 flex items-center justify-center shadow-md">
                <span class="text-white text-lg">ğŸ“š</span>
              </div>
              <div class="min-w-0">
                <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight text-slate-900 truncate">
                  Online Courses
                </h1>
                <p class="mt-1 text-sm text-slate-600">
                  Manage your course catalog â€” search, filter, edit, and publish.
                </p>
              </div>
            </div>

            <div class="mt-4 flex flex-wrap items-center gap-2">
              <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white/70 px-3 py-1 text-xs font-extrabold text-slate-700">
                <span class="text-slate-500">Total:</span> {{ courses|length }}
              </span>
              <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white/70 px-3 py-1 text-xs font-extrabold text-slate-700">
                <span class="text-slate-500">Categories:</span> {{ categories|length }}
              </span>
              <span class="inline-flex items-center gap-2 rounded-full border border-emerald-200 bg-emerald-50 px-3 py-1 text-xs font-extrabold text-emerald-700">
                <span class="h-2 w-2 rounded-full bg-emerald-500"></span>
                Admin Mode
              </span>
            </div>
          </div>

          <div class="flex flex-col sm:flex-row gap-2 sm:items-center">
            <a href="{% url 'app:create_course' %}"
              class="inline-flex items-center justify-center gap-2 rounded-2xl bg-gradient-to-r from-blue-600 to-indigo-600 px-4 py-2.5 text-sm font-extrabold text-white shadow-md hover:shadow-lg transition focus:outline-none focus:ring-4 focus:ring-blue-200">
              <span>ï¼‹</span>
              <span>Upload Course</span>
            </a>

            <button id="exportBtn"
              class="inline-flex items-center justify-center gap-2 rounded-2xl border border-slate-200 bg-white/80 px-4 py-2.5 text-sm font-extrabold text-slate-800 shadow-sm hover:shadow-md hover:bg-white transition focus:outline-none focus:ring-4 focus:ring-blue-100">
              <span id="exportIcon">ğŸ“¥</span>
              <span id="exportText">Export</span>
            </button>
          </div>
        </div>

        <!-- Search + Filters -->
        <div class="mt-6 grid grid-cols-1 lg:grid-cols-12 gap-3">
          <!-- Search -->
          <div class="lg:col-span-6">
            <div class="relative">
              <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">âŒ•</span>
              <input id="searchInput" type="text"
                placeholder="Search by title, instructor, or categoryâ€¦"
                class="w-full rounded-2xl border border-slate-200 bg-white/90 px-10 py-3 text-sm font-semibold text-slate-800 placeholder:text-slate-400 shadow-sm focus:outline-none focus:ring-4 focus:ring-blue-100" />
              <span class="absolute right-3 top-1/2 -translate-y-1/2 text-xs font-extrabold text-slate-400">Ctrl K</span>
            </div>
          </div>

          <!-- Category -->
          <div class="lg:col-span-2">
            <select id="categorySelect"
              class="w-full rounded-2xl border border-slate-200 bg-white/90 px-3 py-3 text-sm font-extrabold text-slate-800 shadow-sm focus:outline-none focus:ring-4 focus:ring-blue-100">
              <option value="all">All categories</option>
              {% for category in categories %}
                <option value="{{ category.name|lower }}">{{ category.name }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Level -->
          <div class="lg:col-span-2">
            <select id="levelSelect"
              class="w-full rounded-2xl border border-slate-200 bg-white/90 px-3 py-3 text-sm font-extrabold text-slate-800 shadow-sm focus:outline-none focus:ring-4 focus:ring-blue-100">
              <option value="all">All levels</option>
              <option value="beginner">Beginner</option>
              <option value="intermediate">Intermediate</option>
              <option value="advanced">Advanced</option>
            </select>
          </div>

          <!-- Price -->
          <div class="lg:col-span-2">
            <select id="priceSelect"
              class="w-full rounded-2xl border border-slate-200 bg-white/90 px-3 py-3 text-sm font-extrabold text-slate-800 shadow-sm focus:outline-none focus:ring-4 focus:ring-blue-100">
              <option value="all">All prices</option>
              <option value="free">Free</option>
              <option value="paid">Paid</option>
            </select>
          </div>
        </div>

        <div class="mt-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
          <p class="text-xs text-slate-500">
            Tip: search is instant. Filters work together.
          </p>
          <p class="text-xs font-extrabold text-slate-700" id="resultCount"></p>
        </div>
      </div>
    </div>

    <!-- Course Grid -->
    <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" id="coursesGrid">
      {% for course in courses %}
      <article
        class="course-card group relative overflow-hidden rounded-3xl border border-slate-200 bg-white shadow-sm hover:shadow-md transition"
        data-title="{{ course.title|default:''|lower }}"
        data-instructor="{{ course.instructor|default:''|lower }}"
        data-category="{{ course.category.name|default:''|lower }}"
        data-level="{{ course.difficulty|default:''|lower }}"
        data-price="{% if course.price|default:0|floatformat:0 == '0' %}free{% else %}paid{% endif %}"
        data-course-id="{{ course.id }}"
      >
        <!-- Thumbnail -->
        <div class="relative h-44 w-full overflow-hidden">
          {% if course.thumbnail %}
            <img src="{{ course.thumbnail.url }}" alt="{{ course.title }}"
              class="h-full w-full object-cover transition duration-300 group-hover:scale-[1.03]" />
          {% else %}
            <div class="h-full w-full bg-gradient-to-br from-blue-600 to-indigo-600 flex items-center justify-center">
              <span class="text-white text-3xl font-black tracking-tight">
                {{ course.title|slice:":3"|upper }}
              </span>
            </div>
          {% endif %}

          <!-- top gradient -->
          <div class="pointer-events-none absolute inset-0 bg-gradient-to-t from-slate-950/35 via-slate-950/0 to-slate-950/0"></div>

          <!-- Dropdown trigger -->
          <button type="button"
            class="dropdown-btn absolute top-3 right-3 inline-flex items-center justify-center h-10 w-10 rounded-2xl bg-white/90 border border-slate-200 shadow-sm hover:bg-white transition focus:outline-none focus:ring-4 focus:ring-blue-100"
            aria-label="Course menu"
            data-dropdown-btn="{{ course.id }}">
            â‹¯
          </button>

          <!-- Dropdown menu -->
          <div
            class="dropdown-menu hidden absolute top-14 right-3 z-20 w-40 overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-lg"
            id="dropdown-{{ course.id }}"
          >
            <button type="button"
              class="w-full px-4 py-3 text-left text-sm font-extrabold text-blue-700 hover:bg-blue-50 transition flex items-center gap-2"
              onclick="editCourse({{ course.id }})">
              âœï¸ <span>Edit</span>
            </button>
            <button type="button"
              class="w-full px-4 py-3 text-left text-sm font-extrabold text-rose-700 hover:bg-rose-50 transition flex items-center gap-2"
              onclick="deleteCourse({{ course.id }})">
              ğŸ—‘ï¸ <span>Delete</span>
            </button>
          </div>
        </div>

        <!-- Body -->
        <div class="p-5">
          <div class="flex items-center justify-between gap-2">
            {% with level=course.difficulty|default:''|lower %}
              {% if level == 'beginner' %}
                <span class="inline-flex items-center rounded-full border border-emerald-200 bg-emerald-50 px-3 py-1 text-[11px] font-extrabold text-emerald-700">
                  Beginner
                </span>
              {% elif level == 'intermediate' %}
                <span class="inline-flex items-center rounded-full border border-amber-200 bg-amber-50 px-3 py-1 text-[11px] font-extrabold text-amber-800">
                  Intermediate
                </span>
              {% else %}
                <span class="inline-flex items-center rounded-full border border-indigo-200 bg-indigo-50 px-3 py-1 text-[11px] font-extrabold text-indigo-700">
                  Advanced
                </span>
              {% endif %}
            {% endwith %}

            <span class="text-xs font-bold text-slate-500 truncate">
              {{ course.category.name }}
            </span>
          </div>

          <h3 class="mt-3 text-base font-extrabold tracking-tight text-slate-900 line-clamp-2">
            {{ course.title }}
          </h3>

          <div class="mt-3 flex items-center gap-3">
            <div class="h-9 w-9 rounded-2xl bg-slate-100 border border-slate-200 flex items-center justify-center font-black text-slate-700">
              {{ course.instructor|default:"I"|slice:":1"|upper }}
            </div>
            <div class="min-w-0">
              <p class="text-sm font-extrabold text-slate-800 truncate">{{ course.instructor }}</p>
              <p class="text-xs text-slate-500">Instructor</p>
            </div>
          </div>

          <div class="mt-4 grid grid-cols-2 gap-2 text-sm">
            <div class="rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2">
              <p class="text-[11px] font-bold text-slate-500">Rating</p>
              <p class="mt-1 font-extrabold text-slate-900">â­ {{ course.rating }} <span class="text-slate-500 font-bold">({{ course.rating_count }})</span></p>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2">
              <p class="text-[11px] font-bold text-slate-500">Students</p>
              <p class="mt-1 font-extrabold text-slate-900">ğŸ‘¥ {{ course.students_count }}</p>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2">
              <p class="text-[11px] font-bold text-slate-500">Duration</p>
              <p class="mt-1 font-extrabold text-slate-900">â± {{ course.duration_weeks }} weeks</p>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2">
              <p class="text-[11px] font-bold text-slate-500">Lessons</p>
              <p class="mt-1 font-extrabold text-slate-900">ğŸ“Œ {{ course.lessons_count }} classes</p>
            </div>
          </div>

          <div class="mt-5 flex items-center justify-between gap-3">
            <span class="inline-flex items-center gap-2 rounded-2xl bg-gradient-to-r from-blue-600 to-indigo-600 px-3 py-2 text-sm font-extrabold text-white shadow-sm">
              ğŸ·ï¸ {{ course.price }} Tk
            </span>

            <a href="#"
              class="inline-flex items-center justify-center rounded-2xl border border-slate-200 bg-white px-3 py-2 text-sm font-extrabold text-slate-800 hover:bg-slate-50 transition focus:outline-none focus:ring-4 focus:ring-blue-100">
              View
            </a>
          </div>
        </div>
      </article>
      {% empty %}
      <div class="col-span-full">
        <div class="rounded-3xl border border-dashed border-slate-200 bg-white p-12 text-center shadow-sm">
          <div class="text-4xl">ğŸ“š</div>
          <h3 class="mt-4 text-lg font-extrabold text-slate-900">No courses available</h3>
          <p class="mt-1 text-sm text-slate-600">Create your first course to start building the catalog.</p>
          <a href="{% url 'app:create_course' %}"
            class="mt-5 inline-flex items-center justify-center gap-2 rounded-2xl bg-gradient-to-r from-blue-600 to-indigo-600 px-5 py-3 text-sm font-extrabold text-white shadow-md hover:shadow-lg transition focus:outline-none focus:ring-4 focus:ring-blue-200">
            ï¼‹ Upload Course
          </a>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- System OK badge only (footer removed) -->
    <div class="mt-6 flex justify-end">
      <span class="inline-flex items-center gap-2 rounded-full border border-emerald-200 bg-emerald-50 px-3 py-1 text-xs font-extrabold text-emerald-700 shadow-sm">
        <span class="h-2 w-2 rounded-full bg-emerald-500"></span> System status: OK
      </span>
    </div>

  </div>
</div>

<script>
  // --- Export micro-interaction (UI only) ---
  (function () {
    const btn = document.getElementById('exportBtn');
    if (!btn) return;
    const icon = document.getElementById('exportIcon');
    const text = document.getElementById('exportText');

    btn.addEventListener('click', () => {
      icon.textContent = 'âœ…';
      text.textContent = 'Exported!';
      btn.classList.add('opacity-90');
      setTimeout(() => {
        icon.textContent = 'ğŸ“¥';
        text.textContent = 'Export';
        btn.classList.remove('opacity-90');
      }, 1600);
    });
  })();

  // --- Dropdown menu handling ---
  (function () {
    function closeAll() {
      document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.add('hidden'));
    }

    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.dropdown-btn');
      if (!btn) {
        closeAll();
        return;
      }
      e.stopPropagation();
      const id = btn.getAttribute('data-dropdown-btn');
      const menu = document.getElementById(`dropdown-${id}`);
      if (!menu) return;

      document.querySelectorAll('.dropdown-menu').forEach(m => {
        if (m !== menu) m.classList.add('hidden');
      });
      menu.classList.toggle('hidden');
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeAll();
    });
  })();

  // --- Search + filter ---
  (function () {
    const searchInput = document.getElementById('searchInput');
    const categorySelect = document.getElementById('categorySelect');
    const levelSelect = document.getElementById('levelSelect');
    const priceSelect = document.getElementById('priceSelect');
    const grid = document.getElementById('coursesGrid');
    const countEl = document.getElementById('resultCount');
    if (!grid) return;

    const cards = Array.from(grid.querySelectorAll('.course-card'));

    function apply() {
      const q = (searchInput?.value || '').trim().toLowerCase();
      const cat = (categorySelect?.value || 'all').toLowerCase();
      const level = (levelSelect?.value || 'all').toLowerCase();
      const price = (priceSelect?.value || 'all').toLowerCase();

      let visible = 0;

      cards.forEach(card => {
        const title = card.dataset.title || '';
        const instructor = card.dataset.instructor || '';
        const category = card.dataset.category || '';
        const lvl = card.dataset.level || '';
        const pr = card.dataset.price || '';

        const matchesQuery = !q || title.includes(q) || instructor.includes(q) || category.includes(q);
        const matchesCat = cat === 'all' || category === cat;
        const matchesLevel = level === 'all' || lvl === level;
        const matchesPrice = price === 'all' || pr === price;

        const show = matchesQuery && matchesCat && matchesLevel && matchesPrice;
        card.classList.toggle('hidden', !show);
        if (show) visible++;
      });

      if (countEl) countEl.textContent = `${visible} result${visible === 1 ? '' : 's'}`;
    }

    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') {
        e.preventDefault();
        searchInput?.focus();
      }
    });

    searchInput?.addEventListener('input', apply);
    categorySelect?.addEventListener('change', apply);
    levelSelect?.addEventListener('change', apply);
    priceSelect?.addEventListener('change', apply);

    apply();
  })();

  // --- Edit / Delete hooks ---
  function editCourse(courseId) {
    window.location.href = `/edit_course/${courseId}/`;
  }

  function getCSRFToken() {
    const name = 'csrftoken';
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return '';
  }

  function deleteCourse(courseId) {
    if (!confirm('Are you sure you want to delete this course?')) return;

    fetch(`/delete_course/${courseId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCSRFToken(),
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ id: courseId })
    })
    .then(res => {
      if (res.ok) {
        const card = document.querySelector(`[data-course-id="${courseId}"]`);
        if (card) card.remove();

        const countEl = document.getElementById('resultCount');
        if (countEl) {
          const current = document.querySelectorAll('.course-card:not(.hidden)').length;
          countEl.textContent = `${current} result${current === 1 ? '' : 's'}`;
        }
      } else {
        alert('Failed to delete course.');
      }
    })
    .catch(() => alert('An error occurred while deleting the course.'));
  }
</script>

{% endblock %}
