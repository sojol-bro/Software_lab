{% extends 'base.html' %}
{% load static %}

{% block content %}

<style>
  .line-clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
  .line-clamp-3{display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;}
  .soft-focus:focus{outline:none;}
  .soft-focus:focus-visible{box-shadow:0 0 0 4px rgba(56,189,248,.18); border-color: rgba(56,189,248,.45);}
  .chip{display:inline-flex;align-items:center;gap:.45rem;border-radius:9999px;border:1px solid rgb(226 232 240);background:#fff;padding:.35rem .7rem;font-weight:700;font-size:.75rem;color:rgb(51 65 85);}
  .no-scrollbar::-webkit-scrollbar{display:none;}
  .no-scrollbar{-ms-overflow-style:none;scrollbar-width:none;}
</style>

<section class="px-4 pt-8 pb-12">
  <div class="container mx-auto max-w-6xl">

    <!-- ===== TOP SHELL (matches Job/Quiz pages) ===== -->
    <div class="relative overflow-hidden rounded-[28px] border border-slate-200 bg-gradient-to-br from-slate-50 via-white to-slate-50 shadow-[0_18px_60px_rgba(15,23,42,0.08)]">
      <div aria-hidden="true" class="pointer-events-none absolute -top-28 -right-28 h-72 w-72 rounded-full bg-slate-200/45 blur-3xl"></div>
      <div aria-hidden="true" class="pointer-events-none absolute -bottom-32 -left-28 h-80 w-80 rounded-full bg-slate-300/30 blur-3xl"></div>

      <div class="relative px-6 py-8 md:px-10 md:py-10">

        <!-- Header row -->
        <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-5">
          <div class="min-w-0">
            <div class="inline-flex items-center gap-2 rounded-full border border-sky-100 bg-sky-50 px-3 py-1 text-xs font-extrabold text-sky-700">
              <i class="fas fa-brain"></i>
              Live Assessment
            </div>

            <h1 class="mt-3 text-2xl md:text-3xl font-extrabold tracking-tight text-slate-900 truncate">
              {{ attempt.quiz.title }}
            </h1>

            <div class="mt-3 flex flex-wrap items-center gap-2">
              <span class="chip">
                <i class="fas fa-question-circle text-slate-400"></i>
                Q{{ current_question.order }} / {{ attempt.quiz.questions.count }}
              </span>

              <span class="chip">
                <i class="fas fa-clock text-slate-400"></i>
                {{ attempt.quiz.duration_minutes }} min
              </span>

              <span class="chip">
                <i class="fas fa-shield-alt text-slate-400"></i>
                No backtracking
              </span>
            </div>
          </div>

          <!-- Timer card -->
          <div class="w-full lg:w-[340px]">
            <div class="rounded-2xl border border-slate-200 bg-white shadow-sm p-5">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <p class="text-xs text-slate-500 font-semibold">Time Remaining</p>
                  <p id="timer" class="mt-1 text-2xl font-extrabold text-slate-900 tabular-nums">
                    {{ attempt.quiz.duration_minutes }}:00
                  </p>
                </div>

                <div class="h-10 w-10 rounded-xl border border-slate-200 bg-white flex items-center justify-center">
                  <i class="fas fa-hourglass-half text-slate-400"></i>
                </div>
              </div>

              <!-- Progress -->
              <div class="mt-4">
                <div class="flex items-center justify-between text-xs text-slate-500">
                  <span class="font-semibold">Progress</span>
                  <span class="font-semibold">
                    {% with answered=attempt.user_answers.count total=attempt.quiz.questions.count %}
                      {{ answered }}/{{ total }} answered
                    {% endwith %}
                  </span>
                </div>

                <div class="mt-2 w-full bg-slate-100 rounded-full h-2 overflow-hidden border border-slate-200">
                  <div id="progressBar"
                       class="bg-sky-600/90 h-2 rounded-full"
                       style="width: {% widthratio attempt.user_answers.count attempt.quiz.questions.count 100 %}%">
                  </div>
                </div>

                <p class="mt-2 text-[11px] text-slate-500">
                  Stay focused â€” your answer is final once you continue.
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- ===== QUESTION CARD ===== -->
        <div class="mt-6 rounded-2xl border border-slate-200 bg-white shadow-sm overflow-hidden">
          <form method="POST" id="quiz-form" class="p-6 md:p-8">
            {% csrf_token %}
            <input type="hidden" name="question_id" value="{{ current_question.id }}">

            <div class="flex items-start justify-between gap-4">
              <div>
                <p class="text-xs font-extrabold text-slate-500 uppercase tracking-wide">
                  Question {{ current_question.order }}
                </p>
                <h2 class="mt-2 text-xl md:text-2xl font-extrabold text-slate-900 leading-snug">
                  {{ current_question.question_text }}
                </h2>
              </div>

              <span class="shrink-0 inline-flex items-center px-2.5 py-1 rounded-full text-xs font-extrabold bg-slate-50 text-slate-700 border border-slate-200">
                Choose one
              </span>
            </div>

            <div class="mt-6 space-y-3">
              {# If you pass selected_choice_id from view, it will pre-check nicely #}
              {% for choice in current_question.choices.all %}
                <label class="group flex items-start gap-3 p-4 rounded-2xl border border-slate-200 bg-white
                              hover:bg-slate-50 transition cursor-pointer">
                  <input
                    type="radio"
                    name="choice_id"
                    value="{{ choice.id }}"
                    class="mt-1 h-5 w-5 text-sky-600 focus:ring-sky-500"
                    {% if selected_choice_id and selected_choice_id|add:"0" == choice.id %}checked{% endif %}
                  >
                  <span class="text-slate-800 leading-relaxed">
                    {{ choice.choice_text }}
                  </span>
                </label>
              {% endfor %}
            </div>

            <!-- Action row -->
            <div class="mt-8 flex flex-col sm:flex-row items-stretch sm:items-center justify-between gap-3 pt-6 border-t border-slate-100">
              <a href="{% url 'app:quiz_list' %}"
                 class="inline-flex items-center justify-center gap-2 px-5 py-3 rounded-xl
                        border border-slate-200 bg-white text-slate-700 font-semibold
                        hover:bg-slate-50 transition soft-focus">
                <i class="fas fa-arrow-left text-slate-400"></i>
                Back to Quizzes
              </a>

              <button type="submit"
                      class="inline-flex items-center justify-center gap-2 px-6 py-3 rounded-xl
                             bg-sky-600/90 text-white font-extrabold shadow-sm
                             hover:bg-sky-700/90 active:scale-[0.98] transition soft-focus">
                {% if attempt.user_answers.count == attempt.quiz.questions.count|add:"-1" %}
                  Finish Quiz
                  <i class="fas fa-flag-checkered text-white/90"></i>
                {% else %}
                  Next Question
                  <i class="fas fa-arrow-right text-white/90"></i>
                {% endif %}
              </button>
            </div>

            <p id="choiceWarn" class="hidden mt-4 text-sm text-rose-600 font-semibold">
              Please select an option before continuing.
            </p>
          </form>
        </div>

        <!-- Note (matches platform style) -->
        <div class="mt-6 rounded-2xl border border-slate-200 bg-white shadow-sm p-5">
          <div class="flex items-start gap-3">
            <div class="h-10 w-10 rounded-xl border border-slate-200 bg-slate-50 flex items-center justify-center shrink-0">
              <i class="fas fa-info-circle text-slate-400"></i>
            </div>
            <div class="min-w-0">
              <p class="text-sm font-extrabold text-slate-900">Note</p>
              <p class="mt-1 text-sm text-slate-600">
                You cannot go back to previous questions. Make sure your answer is final before proceeding.
              </p>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>
</section>

<script>
  // ===== Helpers
  const qs = (s, el=document) => el.querySelector(s);

  // ===== Prevent submit without selecting an answer (fix UX bug)
  (function(){
    const form = qs('#quiz-form');
    const warn = qs('#choiceWarn');
    if(!form) return;

    form.addEventListener('submit', (e) => {
      const picked = form.querySelector('input[name="choice_id"]:checked');
      if(!picked){
        e.preventDefault();
        if(warn) warn.classList.remove('hidden');
        // small shake without CSS libs
        form.classList.add('ring-2','ring-rose-200');
        setTimeout(()=> form.classList.remove('ring-2','ring-rose-200'), 700);
      }
    });

    form.addEventListener('change', () => {
      if(warn) warn.classList.add('hidden');
    });
  })();

  // ===== Timer (Front-end "perfect-ish": persists on refresh via localStorage)
  (function(){
    const timerEl = qs('#timer');
    const form = qs('#quiz-form');
    if(!timerEl || !form) return;

    const attemptId = "{{ attempt.id }}"; // must exist
    const totalSeconds = ({{ attempt.quiz.duration_minutes|default:0 }} * 60) || 0;

    // Store absolute end time per attempt in localStorage so refresh doesn't reset
    const KEY = `skillnet_quiz_end_${attemptId}`;
    let endMs = Number(localStorage.getItem(KEY) || 0);

    if(!endMs){
      endMs = Date.now() + (totalSeconds * 1000);
      localStorage.setItem(KEY, String(endMs));
    }

    function render(sec){
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      timerEl.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }

    function tick(){
      const now = Date.now();
      let left = Math.ceil((endMs - now) / 1000);
      if(left < 0) left = 0;
      render(left);

      if(left <= 0){
        // time is up: submit once
        localStorage.removeItem(KEY); // prevent weird reuse
        form.submit();
        return;
      }
      setTimeout(tick, 1000);
    }

    tick();

    // Cleanup when leaving by submitting (optional; harmless)
    form.addEventListener('submit', () => {
      // keep KEY for next page? you can remove or keep.
      // If you remove here, refresh mid-submit won't re-submit.
      // localStorage.removeItem(KEY);
    });
  })();
</script>

{% endblock %}
