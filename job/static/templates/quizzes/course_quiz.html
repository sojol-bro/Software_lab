{% extends 'base-admin.html' %}
{% load static %}

{% block content_admin %}
<style>
  .line-clamp-1{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;}
  .line-clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
  .no-scrollbar::-webkit-scrollbar{display:none;}
  .no-scrollbar{-ms-overflow-style:none;scrollbar-width:none;}

  /* Consistent premium focus */
  .focus-sky:focus{
    outline:none;
    box-shadow: 0 0 0 4px rgba(14,165,233,.18);
    border-color: rgba(14,165,233,.38);
  }

  /* Smooth appear */
  .fade-in{animation: fadeIn .28s ease both;}
  @keyframes fadeIn{from{opacity:0; transform: translateY(8px);}to{opacity:1; transform: translateY(0);} }

  /* Modal click area */
  #previewModal{display:none;}
  #previewModal.is-open{display:block;}
</style>

<div class="min-h-[70vh] bg-gradient-to-b from-slate-50 via-white to-slate-50">
  <div class="container mx-auto px-4 py-10 max-w-6xl">

    <!-- ================= HEADER ================= -->
    <div class="mb-8 rounded-3xl border border-slate-200 bg-white/70 backdrop-blur-xl shadow-[0_18px_60px_rgba(15,23,42,0.08)] overflow-hidden">
      <div class="relative px-6 md:px-8 py-7">
        <!-- soft blobs like course/job list -->
        <div class="pointer-events-none absolute inset-0">
          <div class="absolute -top-24 -right-24 h-72 w-72 rounded-full bg-sky-200/35 blur-3xl"></div>
          <div class="absolute -bottom-28 -left-24 h-80 w-80 rounded-full bg-indigo-200/25 blur-3xl"></div>
          <div class="absolute inset-0 bg-[radial-gradient(circle_at_20%_20%,rgba(14,165,233,0.10),transparent_55%),radial-gradient(circle_at_85%_30%,rgba(99,102,241,0.08),transparent_55%)]"></div>
        </div>

        <div class="relative flex flex-col md:flex-row md:items-center md:justify-between gap-5">
          <div class="min-w-0">
            <div class="flex flex-wrap items-center gap-2 mb-2">
              <span class="inline-flex items-center gap-2 rounded-full bg-sky-600/90 text-white px-3 py-1 text-xs font-bold shadow-sm">
                <span class="inline-flex h-2 w-2 rounded-full bg-white/90"></span>
                Quiz Builder
              </span>
              <span class="inline-flex items-center gap-2 rounded-full bg-white/80 text-slate-700 ring-1 ring-slate-200 px-3 py-1 text-xs font-semibold">
                Admin Panel
              </span>
              <span class="inline-flex items-center gap-2 rounded-full bg-slate-900/90 text-white px-3 py-1 text-xs font-semibold">
                For Job
              </span>
            </div>

            <h1 class="text-xl md:text-2xl font-extrabold tracking-tight text-slate-900 truncate">
              Build Quiz for: <span class="text-slate-700">{{ job.title }}</span>
            </h1>
            <p class="mt-1 text-sm text-slate-600">
              Create questions, set scoring rules, and preview candidate experience.
            </p>
          </div>

          <!-- Actions -->
          <div class="flex flex-wrap items-center gap-2 md:justify-end">
            <button type="button" id="btn-preview"
              class="inline-flex items-center justify-center rounded-2xl px-4 py-2 text-sm font-semibold
                     ring-1 ring-slate-200 bg-white/80 hover:bg-white transition focus-sky">
              Preview
            </button>

            <button type="button" id="btn-add-question-top"
              class="inline-flex items-center justify-center rounded-2xl px-4 py-2 text-sm font-extrabold
                     bg-sky-600/90 text-white hover:bg-sky-700/90 transition shadow-sm active:scale-[0.99]">
              + Add Question
            </button>
          </div>
        </div>
      </div>

      <!-- ================= STATS STRIP ================= -->
      <div class="px-6 md:px-8 py-4 border-t border-slate-200 bg-white/60">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div class="rounded-2xl bg-white ring-1 ring-slate-200 px-4 py-3">
            <p class="text-xs font-semibold text-slate-500">Questions</p>
            <p class="text-lg font-extrabold text-slate-900"><span id="stat-qcount">0</span></p>
          </div>

          <div class="rounded-2xl bg-white ring-1 ring-slate-200 px-4 py-3">
            <p class="text-xs font-semibold text-slate-500">Total Points</p>
            <p class="text-lg font-extrabold text-slate-900"><span id="stat-totalpoints">0</span></p>
          </div>

          <div class="rounded-2xl bg-white ring-1 ring-slate-200 px-4 py-3">
            <p class="text-xs font-semibold text-slate-500">Passing</p>
            <p class="text-lg font-extrabold text-slate-900"><span id="stat-pass">70</span>%</p>
          </div>

          <div class="rounded-2xl bg-white ring-1 ring-slate-200 px-4 py-3">
            <p class="text-xs font-semibold text-slate-500">Duration</p>
            <p class="text-lg font-extrabold text-slate-900"><span id="stat-duration">30</span> min</p>
          </div>
        </div>
      </div>
    </div>

    <form id="quiz-form" method="post" class="space-y-6">
      {% csrf_token %}

      <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

        <!-- ================= LEFT: BUILDER ================= -->
        <div class="lg:col-span-8 space-y-6">

          <!-- Quiz meta -->
          <section class="rounded-3xl border border-slate-200 bg-white/80 backdrop-blur shadow-[0_18px_60px_rgba(15,23,42,0.06)] overflow-hidden">
            <div class="px-6 md:px-8 py-6 border-b border-slate-200 bg-white/70">
              <h2 class="text-base font-extrabold text-slate-900">Quiz Details</h2>
              <p class="text-sm text-slate-600 mt-1">Title, scoring rules, duration, and instructions.</p>
            </div>

            <div class="p-6 md:p-8 space-y-5">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-semibold text-slate-700 mb-1">Quiz Title <span class="text-rose-500">*</span></label>
                  <input
                    type="text"
                    name="quiz_title"
                    required
                    class="w-full px-4 py-3 rounded-2xl border border-slate-200 bg-white/80 focus-sky"
                    placeholder="e.g. Frontend Skills Quiz"
                  />
                  <p class="mt-2 text-xs text-slate-500">Shown to candidates before they start.</p>
                </div>

                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-1">Passing Score (%)</label>
                    <input
                      id="passing_score"
                      type="number"
                      min="0"
                      max="100"
                      name="passing_score"
                      value="70"
                      class="w-full px-4 py-3 rounded-2xl border border-slate-200 bg-white/80 focus-sky"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-1">Duration (min)</label>
                    <input
                      id="duration_minutes"
                      type="number"
                      min="1"
                      name="duration_minutes"
                      value="30"
                      class="w-full px-4 py-3 rounded-2xl border border-slate-200 bg-white/80 focus-sky"
                    />
                  </div>
                </div>

                <div class="md:col-span-2">
                  <label class="block text-sm font-semibold text-slate-700 mb-1">Description (optional)</label>
                  <textarea
                    name="quiz_description"
                    rows="3"
                    class="w-full px-4 py-3 rounded-2xl border border-slate-200 bg-white/80 focus-sky"
                    placeholder="Short instructions, topics covered, any rules..."
                  ></textarea>
                </div>
              </div>

              <!-- Rules -->
              <div class="rounded-3xl border border-slate-200 bg-slate-50/80 p-5">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                  <div>
                    <p class="text-sm font-extrabold text-slate-900">Quiz Rules</p>
                    <p class="text-xs text-slate-600 mt-1">Front-end helper flags (save if your backend supports).</p>
                  </div>
                </div>

                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
                  <label class="flex items-start gap-3 rounded-3xl bg-white p-4 ring-1 ring-slate-200 cursor-pointer hover:bg-slate-50 transition">
                    <input type="checkbox" class="mt-1" id="rule_shuffle_questions" name="rule_shuffle_questions" />
                    <div>
                      <p class="text-sm font-semibold text-slate-900">Shuffle questions</p>
                      <p class="text-xs text-slate-600">Candidates see questions in random order.</p>
                    </div>
                  </label>

                  <label class="flex items-start gap-3 rounded-3xl bg-white p-4 ring-1 ring-slate-200 cursor-pointer hover:bg-slate-50 transition">
                    <input type="checkbox" class="mt-1" id="rule_shuffle_choices" name="rule_shuffle_choices" />
                    <div>
                      <p class="text-sm font-semibold text-slate-900">Shuffle choices</p>
                      <p class="text-xs text-slate-600">Randomize options for MCQ.</p>
                    </div>
                  </label>

                  <label class="flex items-start gap-3 rounded-3xl bg-white p-4 ring-1 ring-slate-200 cursor-pointer hover:bg-slate-50 transition">
                    <input type="checkbox" class="mt-1" id="rule_one_correct" name="rule_one_correct" checked />
                    <div>
                      <p class="text-sm font-semibold text-slate-900">Single correct by default</p>
                      <p class="text-xs text-slate-600">MCQ: only one correct unless toggled per question.</p>
                    </div>
                  </label>

                  <label class="flex items-start gap-3 rounded-3xl bg-white p-4 ring-1 ring-slate-200 cursor-pointer hover:bg-slate-50 transition">
                    <input type="checkbox" class="mt-1" id="rule_require_all" name="rule_require_all" />
                    <div>
                      <p class="text-sm font-semibold text-slate-900">Require all answered</p>
                      <p class="text-xs text-slate-600">Block submit if any is incomplete (client-side).</p>
                    </div>
                  </label>
                </div>
              </div>
            </div>
          </section>

          <!-- Questions builder -->
          <section class="rounded-3xl border border-slate-200 bg-white/80 backdrop-blur shadow-[0_18px_60px_rgba(15,23,42,0.06)] overflow-hidden">
            <div class="px-6 md:px-8 py-6 border-b border-slate-200 bg-white/70 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
              <div>
                <h2 class="text-base font-extrabold text-slate-900">Questions</h2>
                <p class="text-sm text-slate-600 mt-1">Add, reorder, and assign points.</p>
              </div>

              <div class="flex flex-wrap items-center gap-2">
                <div class="relative">
                  <input
                    id="searchQuestions"
                    type="text"
                    class="w-full md:w-72 pl-10 pr-14 py-2.5 rounded-2xl border border-slate-200 bg-white/80 focus-sky"
                    placeholder="Search questions..."
                  />
                  <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm"></i>
                  <div class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs font-bold">Ctrl K</div>
                </div>

                <button type="button" id="add-question"
                  class="inline-flex items-center justify-center rounded-2xl px-4 py-2.5 text-sm font-extrabold
                         bg-sky-600/90 text-white hover:bg-sky-700/90 transition shadow-sm active:scale-[0.99]">
                  + Add
                </button>

                <button type="button" id="btn-expand-all"
                  class="inline-flex items-center justify-center rounded-2xl px-4 py-2.5 text-sm font-semibold
                         ring-1 ring-slate-200 bg-white/80 hover:bg-white transition focus-sky">
                  Expand all
                </button>

                <button type="button" id="btn-collapse-all"
                  class="inline-flex items-center justify-center rounded-2xl px-4 py-2.5 text-sm font-semibold
                         ring-1 ring-slate-200 bg-white/80 hover:bg-white transition focus-sky">
                  Collapse all
                </button>
              </div>
            </div>

            <div class="p-6 md:p-8">
              <div id="emptyState" class="hidden rounded-3xl border border-dashed border-slate-300 bg-slate-50/80 p-10 text-center fade-in">
                <div class="mx-auto w-14 h-14 rounded-3xl bg-white ring-1 ring-slate-200 flex items-center justify-center">
                  <i class="fas fa-list-check text-slate-400 text-xl"></i>
                </div>
                <p class="mt-4 text-base font-extrabold text-slate-900">No questions yet</p>
                <p class="text-sm text-slate-600 mt-2">Add your first question to start building the quiz.</p>
                <button type="button" id="btn-empty-add"
                  class="mt-5 inline-flex items-center justify-center rounded-2xl px-5 py-2.5 text-sm font-extrabold
                         bg-sky-600/90 text-white hover:bg-sky-700/90 transition shadow-sm active:scale-[0.99]">
                  + Add first question
                </button>
              </div>

              <!-- JS injects question cards here -->
              <div id="questions" class="space-y-4"></div>

              <div class="mt-6 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                <p class="text-xs text-slate-500">
                  Tip: drag the handle to reorder. Use “Duplicate” to quickly create similar questions.
                </p>

                <!-- Type buttons: unified to platform sky -->
                <div class="flex items-center gap-2">
                  <button type="button" id="btn-add-mcq"
                    class="rounded-2xl px-4 py-2 text-sm font-extrabold bg-sky-600/90 text-white hover:bg-sky-700/90 transition shadow-sm active:scale-[0.99]">
                    + MCQ
                  </button>
                  <button type="button" id="btn-add-truefalse"
                    class="rounded-2xl px-4 py-2 text-sm font-extrabold bg-sky-600/90 text-white hover:bg-sky-700/90 transition shadow-sm active:scale-[0.99]">
                    + True/False
                  </button>
                  <button type="button" id="btn-add-short"
                    class="rounded-2xl px-4 py-2 text-sm font-extrabold bg-sky-600/90 text-white hover:bg-sky-700/90 transition shadow-sm active:scale-[0.99]">
                    + Short Answer
                  </button>
                </div>
              </div>
            </div>
          </section>
        </div>

        <!-- ================= RIGHT: SUMMARY ================= -->
        <aside class="lg:col-span-4 space-y-6 lg:sticky lg:top-24 self-start">

          <div class="rounded-3xl border border-slate-200 bg-white/80 backdrop-blur shadow-[0_18px_60px_rgba(15,23,42,0.06)] overflow-hidden">
            <div class="px-6 py-6 border-b border-slate-200 bg-white/70">
              <h3 class="text-base font-extrabold text-slate-900">Summary</h3>
              <p class="text-sm text-slate-600 mt-1">Quick checks before saving.</p>
            </div>

            <div class="p-6 space-y-4">
              <div class="rounded-3xl bg-slate-50/80 p-4 ring-1 ring-slate-200">
                <div class="flex items-center justify-between">
                  <p class="text-sm font-semibold text-slate-700">Validity</p>
                  <span id="validBadge" class="text-xs font-bold px-2.5 py-1 rounded-full bg-rose-50 text-rose-700 ring-1 ring-rose-200">
                    Needs work
                  </span>
                </div>
                <ul class="mt-3 space-y-2 text-sm text-slate-700" id="validationList"></ul>
              </div>

              <div class="rounded-3xl bg-white ring-1 ring-slate-200 p-4">
                <p class="text-xs font-semibold text-slate-500">Total points</p>
                <p class="text-2xl font-extrabold text-slate-900 mt-1"><span id="sumTotalPoints">0</span></p>
              </div>

              <div class="grid grid-cols-2 gap-3">
                <div class="rounded-3xl bg-white ring-1 ring-slate-200 p-4">
                  <p class="text-xs font-semibold text-slate-500">Questions</p>
                  <p class="text-xl font-extrabold text-slate-900 mt-1"><span id="sumQuestions">0</span></p>
                </div>
                <div class="rounded-3xl bg-white ring-1 ring-slate-200 p-4">
                  <p class="text-xs font-semibold text-slate-500">Avg. points</p>
                  <p class="text-xl font-extrabold text-slate-900 mt-1"><span id="sumAvgPoints">0</span></p>
                </div>
              </div>
            </div>

            <div class="p-6 border-t border-slate-200 bg-slate-50/80">
              <div class="flex flex-col gap-3">
                <button type="submit"
                  class="w-full inline-flex items-center justify-center rounded-2xl px-5 py-3 text-sm font-extrabold
                         bg-sky-600/90 text-white hover:bg-sky-700/90 transition shadow-sm active:scale-[0.99]">
                  Save Quiz and Continue
                </button>

                <button type="button" id="btn-save-draft"
                  class="w-full inline-flex items-center justify-center rounded-2xl px-5 py-3 text-sm font-extrabold
                         ring-1 ring-slate-200 bg-white/80 hover:bg-white transition focus-sky">
                  Save as Draft (client only)
                </button>

                <p class="text-[11px] text-slate-500">
                  Draft is stored in your browser (localStorage). It won’t affect backend until you submit.
                </p>
              </div>
            </div>
          </div>

          <!-- Shortcuts -->
          <div class="rounded-3xl border border-slate-200 bg-white/80 backdrop-blur shadow-[0_18px_60px_rgba(15,23,42,0.06)] overflow-hidden">
            <div class="px-6 py-6 border-b border-slate-200 bg-white/70">
              <h3 class="text-base font-extrabold text-slate-900">Shortcuts</h3>
            </div>
            <div class="p-6 text-sm text-slate-700 space-y-2">
              <div class="flex items-center justify-between"><span>Add question</span><kbd class="px-2 py-1 rounded-lg bg-slate-100 ring-1 ring-slate-200 text-xs font-bold">Ctrl</kbd> + <kbd class="px-2 py-1 rounded-lg bg-slate-100 ring-1 ring-slate-200 text-xs font-bold">Enter</kbd></div>
              <div class="flex items-center justify-between"><span>Preview</span><kbd class="px-2 py-1 rounded-lg bg-slate-100 ring-1 ring-slate-200 text-xs font-bold">Ctrl</kbd> + <kbd class="px-2 py-1 rounded-lg bg-slate-100 ring-1 ring-slate-200 text-xs font-bold">P</kbd></div>
              <div class="flex items-center justify-between"><span>Search</span><kbd class="px-2 py-1 rounded-lg bg-slate-100 ring-1 ring-slate-200 text-xs font-bold">Ctrl</kbd> + <kbd class="px-2 py-1 rounded-lg bg-slate-100 ring-1 ring-slate-200 text-xs font-bold">K</kbd></div>
            </div>
          </div>

        </aside>
      </div>
    </form>
  </div>
</div>

<!-- ================= PREVIEW MODAL ================= -->
<div id="previewModal" class="fixed inset-0 z-[999] hidden">
  <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm"></div>
  <div class="relative h-full w-full flex items-center justify-center p-4">
    <div class="w-full max-w-4xl rounded-3xl bg-white shadow-[0_30px_120px_rgba(0,0,0,0.35)] overflow-hidden">
      <div class="px-6 md:px-8 py-5 border-b border-slate-200 flex items-center justify-between">
        <div class="min-w-0">
          <p class="text-xs font-bold text-slate-500">Candidate Preview</p>
          <h3 class="text-lg md:text-xl font-extrabold text-slate-900 truncate" id="previewTitle">Quiz Preview</h3>
        </div>
        <button id="closePreview"
          class="rounded-2xl px-3 py-2 text-sm font-semibold ring-1 ring-slate-200 hover:bg-slate-50 transition focus-sky">
          Close
        </button>
      </div>

      <div class="p-6 md:p-8 max-h-[75vh] overflow-auto">
        <div class="rounded-3xl bg-slate-50 ring-1 ring-slate-200 p-4 mb-6">
          <div class="flex flex-wrap items-center gap-2 text-sm">
            <span class="inline-flex items-center gap-2 rounded-full bg-white ring-1 ring-slate-200 px-3 py-1">
              ⏱ <span class="font-semibold" id="previewDuration">30</span> min
            </span>
            <span class="inline-flex items-center gap-2 rounded-full bg-white ring-1 ring-slate-200 px-3 py-1">
              ✅ Pass <span class="font-semibold" id="previewPass">70</span>%
            </span>
            <span class="inline-flex items-center gap-2 rounded-full bg-white ring-1 ring-slate-200 px-3 py-1">
              ⭐ Points <span class="font-semibold" id="previewPoints">0</span>
            </span>
          </div>
          <p class="text-sm text-slate-600 mt-3" id="previewDesc"></p>
        </div>

        <div id="previewBody" class="space-y-6"></div>
      </div>
    </div>
  </div>
</div>

<style>
  input[type="number"]::-webkit-outer-spin-button,
  input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
</style>

<script>
/* ✅ YOUR ORIGINAL JS (UNCHANGED) */
{{ block.super }}
</script>

<!-- IMPORTANT:
  Keep your full JS EXACTLY as you already have it below.
  I did not change any ID/hooks it uses.
-->
<script>
/* ==========================================================
  NEXT-LEVEL QUIZ BUILDER (Vanilla JS)
  ... (PASTE YOUR EXISTING JS HERE EXACTLY, unchanged)
========================================================== */
</script>

{% endblock %}
